<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASHWIN - Ultimate Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #ff6b6b; --sidebar-bg: #1a1c23; --main-bg: #f4f7fe; --white: #ffffff; --success: #2ecc71; --danger: #e74c3c; --blue: #3498db; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--main-bg); display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 25px 0; position: fixed; height: 100vh; z-index: 100; }
        .sidebar-brand { padding: 0 25px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .nav-link { display: flex; align-items: center; padding: 12px 25px; color: #a0aec0; text-decoration: none; transition: 0.3s; gap: 12px; font-size: 14px; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: rgba(255,107,107,0.1); color: var(--primary); border-right: 4px solid var(--primary); }

        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 30px; }
        .section { display: none; }
        .section.active { display: block; }

        /* Cards & Tables */
        .stat-card { background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); text-align: center; }
        .card { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.02); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; color: #8492a6; font-size: 12px; border-bottom: 1px solid #eee; }
        td { padding: 12px; font-size: 13px; border-bottom: 1px solid #f9f9f9; }

        /* Game Grid */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 15px; }
        .game-edit-box { border: 1px solid #edf2f7; padding: 15px; border-radius: 15px; background: #f8fafc; text-align: center; }
        .preview-img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; background: #eee; }
        
        /* Inputs & Buttons */
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; }
        .btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 11px; color: white; }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-blue { background: var(--blue); }
        .btn-black { background: #000; }

        #loginOverlay { position: fixed; inset: 0; background: #1a1c23; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #2d3748; color: white; padding: 12px 25px; border-radius: 10px; display: none; z-index: 11000; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div style="background: white; padding: 40px; border-radius: 25px; text-align: center; width: 350px;">
        <i class="fas fa-user-shield" style="font-size:40px; color:var(--primary);"></i>
        <h2 style="margin: 15px 0;">Admin Auth</h2>
        <input type="password" id="adminPass" placeholder="Enter Key" style="text-align:center;">
        <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="checkAuth()">LOGIN</button>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-brand"><h2>CASHWIN</h2></div>
    <div class="nav-link active" onclick="showSection('userSection', this)"><i class="fas fa-users"></i> User Control</div>
    <div class="nav-link" onclick="showSection('gameSection', this)"><i class="fas fa-gamepad"></i> Game Content</div>
    <div class="nav-link" onclick="resetAllRigging()"><i class="fas fa-sync"></i> Reset All Rigging</div>
</div>

<div class="main-content">
    
    <div id="userSection" class="section active">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <div class="stat-card"> <h3 id="totalUsers">0</h3> <p>Users</p> </div>
            <div class="stat-card"> <h3 id="totalVolume">â‚¹0</h3> <p>Play Volume</p> </div>
            <button class="btn btn-primary" onclick="resetAllRigging()">RESET ALL RIGGING</button>
        </div>

        <div class="card">
            <h3>Active Users & Wallets</h3>
            <table>
                <thead>
                    <tr>
                        <th>Mobile</th>
                        <th>Balance</th>
                        <th>Vault</th>
                        <th>VIP Exp</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="gameSection" class="section">
        <div class="card">
            <h3>Popular Games Image & Link Manager</h3>
            <div class="game-grid" id="popularGrid"></div>
        </div>
        <div class="card" style="margin-top: 30px;">
            <h3>Hot Games Manager</h3>
            <div class="game-grid" id="hotGrid"></div>
        </div>
    </div>

</div>

<div id="toast" class="toast">Action Successful!</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.checkAuth = () => {
        if(document.getElementById('adminPass').value === "admin123"){
            document.getElementById('loginOverlay').style.display = 'none';
            initAdmin();
        } else { alert("Wrong Password!"); }
    };

    window.showSection = (id, el) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    };

    function initAdmin() {
        loadUserData();
        loadGameEditors();
    }

    // --- USER LOGIC ---
    function loadUserData() {
        onValue(ref(db, 'users'), (snap) => {
            const users = snap.val();
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = "";
            let vol = 0; let count = 0;

            for(let id in users) {
                const u = users[id]; count++; vol += (u.totalBetAmount || 0);
                const isLocked = u.lastUnlink && (Date.now() - u.lastUnlink < 259200000);
                
                tbody.innerHTML += `
                    <tr>
                        <td><b>${id}</b></td>
                        <td style="color:var(--success)">â‚¹${(u.balance || 0).toFixed(2)}</td>
                        <td style="color:orange">â‚¹${(u.vault || 0).toFixed(2)}</td>
                        <td>${u.totalBetAmount || 0}</td>
                        <td>${isLocked ? 'ðŸ”´ Locked' : 'ðŸŸ¢ Ready'}</td>
                        <td>
                            <button class="btn btn-success" onclick="unlockDev('${id}')">Unlock</button>
                            <button class="btn btn-blue" onclick="addBonus('${id}')">+â‚¹100</button>
                            <button class="btn btn-black" onclick="rigUser('${id}', 'win')">Rig Win</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('totalUsers').innerText = count;
            document.getElementById('totalVolume').innerText = "â‚¹" + vol.toLocaleString();
        });
    }

    // --- GAME EDITOR LOGIC ---
    function loadGameEditors() {
        ['popular', 'hot'].forEach(cat => {
            const grid = document.getElementById(cat + 'Grid');
            grid.innerHTML = "";
            for(let i=1; i<=4; i++) { // Managing 4 slots per category
                const box = document.createElement('div');
                box.className = 'game-edit-box';
                box.innerHTML = `
                    <img id="prev_${cat}_${i}" class="preview-img">
                    <input type="file" onchange="previewImg('${cat}', ${i}, this)" style="font-size:10px">
                    <input type="text" id="n_${cat}_${i}" placeholder="Game Name">
                    <input type="text" id="l_${cat}_${i}" placeholder="Link (e.g. wingo.html)">
                    <button class="btn btn-primary" style="width:100%" onclick="saveGame('${cat}', ${i})">SAVE SLOT ${i}</button>
                `;
                grid.appendChild(box);

                onValue(ref(db, `admin/games/${cat}/game_${i}`), (s) => {
                    const d = s.val();
                    if(d) {
                        document.getElementById(`n_${cat}_${i}`).value = d.name || "";
                        document.getElementById(`l_${cat}_${i}`).value = d.link || "";
                        document.getElementById(`prev_${cat}_${i}`).src = d.image || "";
                    }
                });
            }
        });
    }

    // --- HELPER FUNCTIONS ---
    window.previewImg = (cat, i, input) => {
        const reader = new FileReader();
        reader.onload = (e) => { document.getElementById(`prev_${cat}_${i}`).src = e.target.result; };
        reader.readAsDataURL(input.files[0]);
    };

    window.saveGame = (cat, i) => {
        const data = {
            name: document.getElementById(`n_${cat}_${i}`).value,
            link: document.getElementById(`l_${cat}_${i}`).value,
            image: document.getElementById(`prev_${cat}_${i}`).src
        };
        set(ref(db, `admin/games/${cat}/game_${i}`), data).then(() => showToast("Game Updated!"));
    };

    window.unlockDev = (id) => {
        update(ref(db, `users/${id}`), { lastUnlink: 0, linkedDev: null }).then(() => showToast("Unlocked"));
    };

    window.addBonus = (id) => {
        const uRef = ref(db, `users/${id}`);
        onValue(uRef, (s) => {
            const b = s.val().balance || 0;
            update(uRef, { balance: b + 100 });
            set(ref(db, `users/${id}/history/${Date.now()}`), { amount: 100, type: 'deposit', game: 'ADMIN BONUS', time: Date.now() });
        }, { onlyOnce: true });
        showToast("Bonus Added");
    };

    window.rigUser = (id, type) => {
        set(ref(db, `admin/rigging/forceWin`), id).then(() => showToast("User Rigged to Win"));
    };

    window.resetAllRigging = () => {
        set(ref(db, 'admin/rigging'), { forceWin: "none", forceLoss: "none" }).then(() => showToast("Rigging Cleared"));
    };

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>
</body>
</html>
