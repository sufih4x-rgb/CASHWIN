<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Pro - Enterprise Global Sync</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #000; --panel: #1b1c21; --accent: #e11d48; --gold: #facc15; --win: #22c55e; }
        body { margin: 0; background: var(--bg); font-family: 'Inter', sans-serif; color: white; overflow: hidden; }

        .history-bar { height: 35px; background: #000; display: flex; align-items: center; gap: 8px; padding: 0 10px; overflow-x: auto; border-bottom: 1px solid #222; }
        .hist-item { font-size: 11px; padding: 2px 10px; border-radius: 12px; font-weight: bold; background: #1b1c21; border: 1px solid #333; }
        .hist-low { color: #34b5f8; } .hist-mid { color: #913dff; } .hist-high { color: #c01d48; }

        .result-popup { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); padding: 20px 40px; border-radius: 15px; font-weight: 900; font-size: 24px; z-index: 4000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        .popup-win { background: var(--win); color: white; box-shadow: 0 0 30px var(--win); }
        .popup-loss { background: var(--accent); color: white; box-shadow: 0 0 30px var(--accent); }
        .show-popup { transform: translate(-50%, -50%) scale(1); }

        #authOverlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 20px; text-align: center; width: 320px; border: 1px solid #333; }
        .auth-card input { width: 90%; padding: 15px; margin: 15px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; outline: none; }

        #gameContainer { height: 100vh; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
        .top-nav { height: 50px; background: #141518; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid #222; }
        
        .game-main { flex: 1; display: flex; overflow: hidden; }
        .sidebar-bets { width: 140px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; font-size: 10px; padding: 5px; overflow: hidden; }
        .bet-row { display: flex; justify-content: space-between; padding: 6px 4px; border-bottom: 1px solid #1a1a1a; color: #888; }

        .stage-area { flex: 1; position: relative; background: radial-gradient(circle at bottom left, #1e0a0a, #000); margin: 10px; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
        #timerBox { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--accent); font-weight: bold; font-size: 11px; color: var(--accent); z-index: 200; }
        #multiplier { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 65px; font-weight: 900; z-index: 100; }
        
        #planeWrapper { position: absolute; bottom: 30px; left: 30px; width: 90px; z-index: 50; will-change: transform; transition: transform 0.1s linear; }
        #planeImg { width: 100%; filter: drop-shadow(0 0 15px var(--accent)); }

        .control-board { background: var(--panel); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; border-top: 1px solid #333; }
        .bet-box { background: #000; border: 1px solid #2a2a2a; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .main-btn { width: 100%; height: 55px; border-radius: 10px; border: none; font-weight: 900; font-size: 18px; cursor: pointer; text-transform: uppercase; }
        .btn-bet { background: var(--win); color: white; box-shadow: 0 4px 0 #15803d; }
        .btn-cashout { background: var(--gold); color: black; box-shadow: 0 4px 0 #a16207; }
        .btn-waiting { background: #333; color: #666; cursor: not-allowed; }
        
        .flew-away { transform: translate(1200px, -600px) rotate(-15deg) !important; transition: 1.8s ease-in !important; }
    </style>
</head>
<body>

    <div id="winPopup" class="result-popup popup-win">WON ₹<span id="winAmtDisp">0</span></div>
    <div id="lossPopup" class="result-popup popup-loss">FLEW AWAY!</div>

    <div id="authOverlay">
        <div class="auth-card">
            <h2 style="color:var(--accent)">LINK WALLET</h2>
            <p style="font-size: 11px; color: #888;">Enter your registered mobile number</p>
            <input type="number" id="userPhone" placeholder="91XXXXXXXX">
            <button onclick="linkWallet()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">CONNECT BALANCE</button>
            <p id="lockMsg" style="color:#ff4444; font-size:11px; margin-top:12px; display:none; border:1px solid #444; padding:5px;">
                SECURITY: Device Mismatch. <br>Wait <span id="daysLeft">3</span> Days for transfer.
            </p>
        </div>
    </div>

    <div id="gameContainer">
        <div class="history-bar" id="historyBar"></div>
        <div class="top-nav">
            <span style="color:var(--accent); font-weight:900; letter-spacing:1px;">AVIATOR PRO</span>
            <div style="background:#000; padding:5px 18px; border-radius:20px; border:1px solid #333; font-weight:bold;">
                ₹<span id="balanceDisp">0.00</span>
            </div>
            <i class="fas fa-history" style="color:#555"></i>
        </div>

        <div class="game-main">
            <div class="sidebar-bets" id="sideBets">
                <div style="color:#555; font-weight:bold; margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:5px;">LIVE BETS</div>
            </div>
            <div class="stage-area">
                <div id="timerBox">SYNCING...</div>
                <div id="multiplier">1.00x</div>
                <div id="planeWrapper"><img src="https://static.vecteezy.com/system/resources/previews/012/000/658/original/airplane-aircraft-flat-design-free-png.png" id="planeImg"></div>
            </div>
        </div>

        <div class="control-board">
            <div class="bet-box">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="changeAmt(-10)" style="color:white; background:#333; border:none; border-radius:50%; width:28px; height:28px;">-</button>
                    <input type="number" id="betAmt" value="10" readonly style="background:none; border:none; color:white; width:50px; text-align:center; font-weight:bold; font-size:16px;">
                    <button onclick="changeAmt(10)" style="color:white; background:#333; border:none; border-radius:50%; width:28px; height:28px;">+</button>
                </div>
                <button id="mainActionBtn" class="main-btn btn-bet" onclick="handleAction()">BET</button>
            </div>
            <div class="bet-box" style="justify-content:center; opacity:0.6;">
                <span style="font-size:10px; color:var(--win); font-weight:bold;">SAFE MODE</span>
                <span id="profitModeTag" style="font-size:9px; color:#555;">GLOBAL SERVER SYNC</span>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const fbConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(fbConfig);
    const db = getDatabase(app);

    let currentPhone = "", userBalance = 0, isBetPlaced = false, hasCashedOut = false;
    let activeBetAmt = 0, gamePhase = "betting", userRigging = "none", depositCount = 0;
    let serverCrashPoint = 1.5;

    // Secure Device ID
    const deviceId = localStorage.getItem('avi_dev_id') || "DV_"+Math.random().toString(36).slice(2, 11);
    localStorage.setItem('avi_dev_id', deviceId);

    async function initBridge() {
        const bridgePhone = localStorage.getItem('avi_ph');
        if (bridgePhone) {
            const snap = await get(ref(db, `users/${bridgePhone}`));
            if (snap.exists()) {
                const u = snap.val();
                // AUTO LINK: If same device, let them in immediately
                if (u.lastDeviceId === deviceId) {
                    currentPhone = bridgePhone;
                    startSync();
                    return;
                }
            }
        }
        document.getElementById('authOverlay').style.display = 'flex';
        document.getElementById('gameContainer').style.opacity = '1';
    }

    window.linkWallet = async () => {
        const ph = document.getElementById('userPhone').value;
        if(ph.length < 10) return alert("Enter valid number");
        const snap = await get(ref(db, `users/${ph}`));
        
        if(!snap.exists()) return alert("User not found in system!");
        
        const u = snap.val();
        // 3-Day Transfer Rule for New Devices
        if(u.lastDeviceId && u.lastDeviceId !== deviceId) {
            const lastUnlink = u.unlinkTime || 0;
            const diff = Date.now() - lastUnlink;
            if (diff < 259200000) {
                const days = 3 - Math.floor(diff / 86400000);
                document.getElementById('daysLeft').innerText = days;
                document.getElementById('lockMsg').style.display = 'block';
                return;
            }
        }

        await update(ref(db, `users/${ph}`), { 
            lastDeviceId: deviceId, 
            lastLogin: serverTimestamp(),
            currentStatus: "CONNECTED"
        });
        currentPhone = ph;
        localStorage.setItem('avi_ph', ph);
        startSync();
    };

    function startSync() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('gameContainer').style.opacity = '1';

        onValue(ref(db, `users/${currentPhone}`), (s) => {
            if(s.exists()){
                const d = s.val();
                userBalance = d.balance || 0;
                userRigging = d.rigging || "none";
                depositCount = d.deposits || 0;
                document.getElementById('balanceDisp').innerText = userBalance.toFixed(2);
            }
        });

        // 25s CYCLE ENGINE
        setInterval(() => {
            const now = Date.now();
            const cycleTime = now % 25000; 

            if (cycleTime < 10000) { // 10s Betting
                updateUI("betting", (10000 - cycleTime) / 1000);
                if (cycleTime < 100) {
                    // CALCULATED CRASH: 1.0 to 6.0 range
                    const seed = Math.random();
                    if (seed > 0.95) serverCrashPoint = Math.random() * 2 + 4; // Rare 4x-6x
                    else if (seed > 0.7) serverCrashPoint = Math.random() * 2 + 2; // Mid 2x-4x
                    else serverCrashPoint = Math.random() * 0.9 + 1.01; // Heavy Loss 1x-1.9x
                }
            } else if (cycleTime < 22000) { // Flying
                const flyTime = (cycleTime - 10000) / 1000;
                const currentMult = Math.pow(1.07, flyTime); 

                let finalCrash = serverCrashPoint;
                if(userRigging === "loss") finalCrash = 1.02;
                if(userRigging === "win" && isBetPlaced) finalCrash = 9.0; // Admin forced win

                if (currentMult >= finalCrash) updateUI("crashed", 0, currentMult);
                else updateUI("flying", flyTime, currentMult);
            } else { 
                if (cycleTime > 24800) location.reload(); // Refresh before next round
                updateUI("crashed", 0);
            }
        }, 100);

        setInterval(addFakeBet, 2800);
    }

    function updateUI(phase, time, mult = 1.0) {
        if (gamePhase === phase && phase !== "flying") return;
        gamePhase = phase;
        
        const btn = document.getElementById('mainActionBtn');
        const plane = document.getElementById('planeWrapper');
        const multTxt = document.getElementById('multiplier');

        if(phase === "betting") {
            hasCashedOut = false;
            multTxt.innerText = "1.00x";
            multTxt.style.color = "white";
            plane.classList.remove('flew-away');
            plane.style.transform = `translate(0,0)`;
            document.getElementById('timerBox').innerText = `NEXT ROUND: ${Math.ceil(time)}s`;
            if(!isBetPlaced) {
                btn.className = "main-btn btn-bet";
                btn.innerText = "BET";
                btn.disabled = false;
            }
            trackAdmin("WAITING");
        } 
        else if (phase === "flying") {
            multTxt.innerText = mult.toFixed(2) + "x";
            document.getElementById('timerBox').innerText = `FLYING`;
            const moveX = Math.min(time * 25, 260);
            const moveY = Math.min(Math.pow(time, 1.3) * 6, 190);
            plane.style.transform = `translate(${moveX}px, -${moveY}px)`;
            
            if(isBetPlaced && !hasCashedOut) {
                btn.className = "main-btn btn-cashout";
                btn.innerText = `CASHOUT ₹${(activeBetAmt * mult).toFixed(2)}`;
            }
        } 
        else if (phase === "crashed") {
            if(mult > 1.01) addHistory(mult);
            multTxt.innerText = "FLEW AWAY!";
            multTxt.style.color = "var(--accent)";
            plane.classList.add('flew-away');
            
            if(isBetPlaced && !hasCashedOut) {
                showPopup("loss");
                isBetPlaced = false;
                btn.className = "main-btn btn-waiting";
                btn.innerText = "LOST";
                trackAdmin("LOST ₹" + activeBetAmt);
            }
            isBetPlaced = false;
        }
    }

    window.handleAction = async () => {
        if(gamePhase === "betting" && !isBetPlaced) {
            const amt = parseFloat(document.getElementById('betAmt').value);
            if(amt > userBalance) return alert("Low Balance");
            await update(ref(db, `users/${currentPhone}`), { balance: increment(-amt) });
            isBetPlaced = true; 
            activeBetAmt = amt;
            document.getElementById('mainActionBtn').innerText = "ACCEPTED";
            document.getElementById('mainActionBtn').className = "main-btn btn-waiting";
            trackAdmin("BET ACTIVE ₹" + amt);
        } 
        else if (gamePhase === "flying" && isBetPlaced && !hasCashedOut) {
            const curMult = parseFloat(document.getElementById('multiplier').innerText);
            const win = activeBetAmt * curMult;
            hasCashedOut = true; 
            isBetPlaced = false;
            await update(ref(db, `users/${currentPhone}`), { balance: increment(win) });
            showPopup("win", win);
            document.getElementById('mainActionBtn').innerText = `WON ₹${win.toFixed(2)}`;
            document.getElementById('mainActionBtn').className = "main-btn btn-waiting";
            trackAdmin("WON ₹" + win.toFixed(2));
        }
    };

    function addHistory(m) {
        const bar = document.getElementById('historyBar');
        const item = document.createElement('div');
        const val = parseFloat(m).toFixed(2);
        item.className = `hist-item ${val < 2 ? 'hist-low' : (val < 4 ? 'hist-mid' : 'hist-high')}`;
        item.innerText = val + "x";
        bar.prepend(item);
        if(bar.children.length > 12) bar.lastElementChild.remove();
    }

    function addFakeBet() {
        const side = document.getElementById('sideBets');
        const row = document.createElement('div');
        row.className = "bet-row";
        row.innerHTML = `<span>91***${Math.floor(Math.random()*899)}</span><span style="color:var(--win)">₹${(Math.random()*200).toFixed(0)}</span>`;
        side.prepend(row);
        if(side.children.length > 20) side.lastElementChild.remove();
    }

    function trackAdmin(status) {
        update(ref(db, `users/${currentPhone}`), { 
            currentStatus: status, 
            lastActivity: serverTimestamp() 
        });
    }

    function showPopup(type, amt) {
        const pop = type === "win" ? document.getElementById('winPopup') : document.getElementById('lossPopup');
        if(type === "win") document.getElementById('winAmtDisp').innerText = amt.toFixed(2);
        pop.classList.add('show-popup');
        setTimeout(() => pop.classList.remove('show-popup'), 2500);
    }

    window.changeAmt = (v) => {
        let cur = parseInt(document.getElementById('betAmt').value);
        if(cur + v >= 10) document.getElementById('betAmt').value = cur + v;
    };

    initBridge();
</script>
</body>
</html>
