<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Pro - Direct Access</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #000; --panel: #1b1c21; --accent: #e11d48; --gold: #facc15; --win: #22c55e; }
        body { margin: 0; background: var(--bg); font-family: 'Inter', sans-serif; color: white; overflow: hidden; }

        /* Popups */
        .result-popup { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); padding: 20px 40px; border-radius: 15px; font-weight: 900; font-size: 24px; z-index: 4000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        .popup-win { background: var(--win); color: white; box-shadow: 0 0 30px var(--win); }
        .popup-loss { background: var(--accent); color: white; box-shadow: 0 0 30px var(--accent); }
        .show-popup { transform: translate(-50%, -50%) scale(1); }

        /* Auth Layer */
        #authOverlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 20px; text-align: center; width: 320px; border: 1px solid #333; }
        .auth-card input { width: 90%; padding: 15px; margin: 15px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; outline: none; }

        /* Main Container */
        #gameContainer { height: 100vh; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
        .top-nav { height: 50px; background: #141518; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid #222; }
        
        /* Layout */
        .game-main { flex: 1; display: flex; overflow: hidden; }
        .sidebar-bets { width: 130px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; font-size: 10px; padding: 5px; overflow-y: hidden; }
        .bet-row { display: flex; justify-content: space-between; padding: 6px 4px; border-bottom: 1px solid #1a1a1a; color: #888; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .stage-area { flex: 1; position: relative; background: radial-gradient(circle at bottom left, #1e0a0a, #000); margin: 10px; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
        #timerBox { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--accent); font-weight: bold; font-size: 11px; color: var(--accent); z-index: 200; }
        #multiplier { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: 900; z-index: 100; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        #planeWrapper { position: absolute; bottom: 30px; left: 30px; width: 70px; z-index: 50; transition: transform 0.1s linear; }
        #planeImg { width: 100%; filter: drop-shadow(0 0 15px var(--accent)); }

        .control-board { background: var(--panel); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; border-top: 1px solid #333; }
        .bet-box { background: #000; border: 1px solid #2a2a2a; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .main-btn { width: 100%; height: 55px; border-radius: 10px; border: none; font-weight: 900; font-size: 18px; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-bet { background: var(--win); color: white; box-shadow: 0 4px 0 #15803d; }
        .btn-cashout { background: var(--gold); color: black; box-shadow: 0 4px 0 #a16207; }
        .btn-waiting { background: #333; color: #666; cursor: not-allowed; }
        
        .flew-away { transform: translate(1200px, -600px) rotate(-15deg) !important; transition: 1.5s ease-in !important; }
    </style>
</head>
<body>

    <div id="winPopup" class="result-popup popup-win">WON ₹<span id="winAmtDisp">0</span></div>
    <div id="lossPopup" class="result-popup popup-loss">FLEW AWAY!</div>

    <div id="authOverlay">
        <div class="auth-card">
            <h2 style="color:var(--accent); margin-bottom: 5px;">ACCOUNT SYNC</h2>
            <input type="number" id="userPhone" placeholder="Enter Mobile Number">
            <button onclick="linkWallet()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">LINK WALLET</button>
            <p id="cooldownText" style="color:#ff4d4d; font-size:11px; display:none; margin-top:10px;">Security Lock: 3 Days Remaining</p>
        </div>
    </div>

    <div id="gameContainer">
        <div class="top-nav">
            <span style="color:var(--accent); font-weight:900;">AVIATOR <small style="font-size: 8px;">PRO</small></span>
            <div style="background:#000; padding:5px 15px; border-radius:20px; border:1px solid #333;">
                <i class="fas fa-wallet" style="color:var(--win); font-size:12px;"></i> ₹<span id="balanceDisp">0.00</span>
            </div>
            <i class="fas fa-sign-out-alt" onclick="unlink()" style="color:#444"></i>
        </div>

        <div class="game-main">
            <div class="sidebar-bets" id="sideBets">
                <div style="color:#555; font-weight:bold; font-size:9px; margin-bottom:5px;">ALL BETS</div>
            </div>
            <div class="stage-area">
                <div id="timerBox">CONNECTING...</div>
                <div id="multiplier">1.00x</div>
                <div id="planeWrapper"><img src="https://static.vecteezy.com/system/resources/previews/012/000/658/original/airplane-aircraft-flat-design-free-png.png" id="planeImg"></div>
            </div>
        </div>

        <div class="control-board">
            <div class="bet-box">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                    <button onclick="changeAmt(-10)" style="background:#222; border:none; color:white; border-radius:5px; width:25px;">-</button>
                    <input type="number" id="betAmt" value="10" readonly style="background:none; border:none; color:white; width:45px; text-align:center; font-weight:bold;">
                    <button onclick="changeAmt(10)" style="background:#222; border:none; color:white; border-radius:5px; width:25px;">+</button>
                </div>
                <button id="mainActionBtn" class="main-btn btn-bet" onclick="handleAction()">BET</button>
            </div>
            <div class="bet-box" style="justify-content:center;">
                <span id="statusMsg" style="font-size: 10px; color: #444; text-align:center;">WAITING FOR NEXT ROUND</span>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const fbConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(fbConfig);
    const db = getDatabase(app);

    let currentPhone = "", userBalance = 0, isBetPlaced = false, hasCashedOut = false;
    let activeBetAmt = 0, gamePhase = "betting", userRigging = "none";
    const deviceId = localStorage.getItem('avi_dev_id') || "DV_"+Math.random().toString(36).slice(2, 11);
    localStorage.setItem('avi_dev_id', deviceId);

    // --- TRACKING SYSTEM: DIRECT BRIDGE ---
    async function checkDirectAccess() {
        // Check local storage for phone (from this game or wallet.html)
        const savedPh = localStorage.getItem('avi_ph') || localStorage.getItem('user_phone');
        
        if (savedPh) {
            const snap = await get(ref(db, `users/${savedPh}`));
            if (snap.exists()) {
                const user = snap.val();
                // If same device, let them in immediately
                if (user.lastDeviceId === deviceId) {
                    currentPhone = savedPh;
                    startSync();
                    return;
                }
            }
        }
        // If no saved phone or different device, show login
        document.getElementById('authOverlay').style.display = 'flex';
        document.getElementById('gameContainer').style.opacity = '1';
    }

    window.linkWallet = async () => {
        const ph = document.getElementById('userPhone').value;
        if(ph.length < 10) return;

        const snap = await get(ref(db, `users/${ph}`));
        if(!snap.exists()) return alert("Mobile number not registered!");

        const user = snap.val();
        if(user.lastDeviceId && user.lastDeviceId !== deviceId) {
            const timePassed = Date.now() - (user.unlinkTime || 0);
            if(timePassed < 3 * 24 * 60 * 60 * 1000) {
                document.getElementById('cooldownText').style.display = "block";
                return;
            }
        }

        await update(ref(db, `users/${ph}`), { 
            lastDeviceId: deviceId, 
            lastLogin: serverTimestamp() 
        });

        currentPhone = ph;
        localStorage.setItem('avi_ph', ph);
        startSync();
    };

    function startSync() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('gameContainer').style.opacity = '1';

        // Tracking User Stats for Admin
        onValue(ref(db, `users/${currentPhone}`), (s) => {
            if(s.exists()){
                const d = s.val();
                userBalance = d.balance;
                userRigging = d.rigging || "none";
                document.getElementById('balanceDisp').innerText = userBalance.toFixed(2);
            }
        });

        // 24H Global Engine Sync
        onValue(ref(db, 'aviator_sync'), (snap) => {
            const data = snap.val();
            if(!data) return;
            const now = Date.now();
            const elapsed = (now - data.startTime) / 1000;
            let crashPoint = data.crashAt || 2.0;

            // Rigging Force
            if(userRigging === "loss") crashPoint = 1.10;
            if(userRigging === "win" && isBetPlaced) crashPoint = 15.0;

            if(elapsed < 10) updateUI("betting", 10 - elapsed);
            else if (elapsed < 55) {
                const flyTime = elapsed - 10;
                const currentMult = Math.pow(1.072, flyTime);
                if(currentMult >= crashPoint) updateUI("crashed", 0);
                else updateUI("flying", flyTime, currentMult);
            } else updateUI("crashed", 0);
        });

        // Fake Active User Bets
        setInterval(() => {
            const side = document.getElementById('sideBets');
            const row = document.createElement('div');
            row.className = "bet-row";
            row.innerHTML = `<span>9${Math.floor(Math.random()*9)}***${Math.floor(Math.random()*99)}</span><span style="color:var(--win)">₹${(Math.random()*200).toFixed(0)}</span>`;
            side.prepend(row);
            if(side.children.length > 20) side.lastElementChild.remove();
        }, 2500);
    }

    function updateUI(phase, time, mult = 1.0) {
        gamePhase = phase;
        const btn = document.getElementById('mainActionBtn');
        const plane = document.getElementById('planeWrapper');
        const multTxt = document.getElementById('multiplier');

        if(phase === "betting") {
            hidePopups();
            hasCashedOut = false;
            multTxt.innerText = "1.00x";
            multTxt.style.color = "white";
            plane.classList.remove('flew-away');
            plane.style.transform = `translate(0,0)`;
            document.getElementById('timerBox').innerText = `STARTING IN ${Math.ceil(time)}s`;
            document.getElementById('statusMsg').innerText = "WAITING FOR NEXT ROUND";
            if(!isBetPlaced) { 
                btn.className = "main-btn btn-bet"; 
                btn.innerText = "BET"; 
                btn.disabled = false; 
            }
        } 
        else if (phase === "flying") {
            multTxt.innerText = mult.toFixed(2) + "x";
            multTxt.style.color = mult > 2 ? "#913dff" : "white";
            document.getElementById('timerBox').innerText = `FLYING`;
            plane.style.transform = `translate(${time * 18}px, -${Math.pow(time, 1.3) * 1.8}px)`;
            if(isBetPlaced && !hasCashedOut) {
                btn.className = "main-btn btn-cashout";
                btn.innerText = `CASHOUT ₹${(activeBetAmt * mult).toFixed(2)}`;
            }
        } 
        else if (phase === "crashed") {
            multTxt.innerText = "FLEW AWAY!";
            multTxt.style.color = "var(--accent)";
            plane.classList.add('flew-away');
            document.getElementById('timerBox').innerText = `CRASHED`;
            if(isBetPlaced && !hasCashedOut) {
                showPopup("loss");
                isBetPlaced = false;
                btn.className = "main-btn btn-waiting"; 
                btn.innerText = "FLEW AWAY";
            }
            isBetPlaced = false;
        }
    }

    window.handleAction = async () => {
        if(gamePhase === "betting" && !isBetPlaced) {
            const amt = parseFloat(document.getElementById('betAmt').value);
            if(amt > userBalance) return alert("Insufficient Balance");
            
            await update(ref(db, `users/${currentPhone}`), { 
                balance: increment(-amt),
                lastBet: amt,
                status: "betting"
            });
            
            isBetPlaced = true; 
            activeBetAmt = amt;
            document.getElementById('mainActionBtn').innerText = "WAIT FOR NEXT";
            document.getElementById('mainActionBtn').className = "main-btn btn-waiting";
            document.getElementById('statusMsg').innerText = "BET ACCEPTED";
        } 
        else if (gamePhase === "flying" && isBetPlaced && !hasCashedOut) {
            const currentMult = parseFloat(document.getElementById('multiplier').innerText);
            const win = activeBetAmt * currentMult;
            hasCashedOut = true; 
            isBetPlaced = false;
            
            await update(ref(db, `users/${currentPhone}`), { 
                balance: increment(win),
                status: "won"
            });
            showPopup("win", win);
            document.getElementById('mainActionBtn').innerText = `WON ₹${win.toFixed(2)}`;
            document.getElementById('mainActionBtn').className = "main-btn btn-waiting";
        }
    };

    function showPopup(type, amt) {
        if(type === "win") {
            document.getElementById('winAmtDisp').innerText = amt.toFixed(2);
            document.getElementById('winPopup').classList.add('show-popup');
        } else {
            document.getElementById('lossPopup').classList.add('show-popup');
        }
        setTimeout(hidePopups, 2500);
    }

    function hidePopups() {
        document.getElementById('winPopup').classList.remove('show-popup');
        document.getElementById('lossPopup').classList.remove('show-popup');
    }

    window.changeAmt = (v) => {
        let cur = parseInt(document.getElementById('betAmt').value);
        if(cur + v >= 10) document.getElementById('betAmt').value = cur + v;
    };

    window.unlink = async () => {
        if(confirm("Unlink device? 3-day restriction will apply.")) {
            await update(ref(db, `users/${currentPhone}`), { unlinkTime: Date.now() });
            localStorage.clear();
            location.reload();
        }
    };

    checkDirectAccess();
</script>
</body>
</html>
