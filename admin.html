<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASHWIN - Master Control Center v2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60; --bg: #f4f7f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { color: var(--accent); margin-bottom: 30px; text-align: center; font-style: italic; }
        .nav-link { padding: 12px; color: #ecf0f1; text-decoration: none; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: var(--accent); }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        .header-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .stat-card.profit { border-left-color: var(--success); }
        
        .section { display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .section.active { display: block; }

        /* Tables & UI */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f9f9f9; color: #777; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--accent); }
        .btn-reset { background: #3498db; width: 100%; margin-top: 15px; }

        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 11px; color: white; font-weight: bold; }
        .slider-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .rig-box { border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-top: 15px; display: flex; align-items: center; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>CASHWIN ADMIN</h2>
        <div class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
        <div class="nav-link" onclick="showSection('users')"><i class="fas fa-users"></i> User Management</div>
        <div class="nav-link" onclick="showSection('wingo')"><i class="fas fa-gamepad"></i> WinGo Control</div>
        <div class="nav-link" onclick="showSection('slider')"><i class="fas fa-images"></i> Slider & URLs</div>
        <div class="nav-link" onclick="showSection('transactions')"><i class="fas fa-wallet"></i> Transactions History</div>
        <div class="nav-link" onclick="showSection('recharge')"><i class="fas fa-sim-card"></i> SIM Recharge</div>
    </div>

    <div class="main-content">
        <div class="header-stats">
            <div class="stat-card"><h3>Admin Profit</h3><h2 id="adminTotalProfit" style="color:var(--success)">₹0</h2></div>
            <div class="stat-card"><h3>User Total Loss</h3><h2 id="userTotalLoss" style="color:var(--accent)">₹0</h2></div>
            <div class="stat-card"><h3>Total Deposits</h3><h2 id="totalDeposits">₹0</h2></div>
            <div class="stat-card"><h3>Admin Status</h3><select id="adminStatusSet" onchange="updateAdminStatus()"><option value="online">Online</option><option value="offline">Offline</option></select></div>
        </div>

        <div id="dashboard" class="section active">
            <h2>Real-time Live Bets (Global)</h2>
            <table id="liveBetsTable">
                <thead><tr><th>Phone</th><th>Game Mode</th><th>Bet On</th><th>Amount</th><th>Status</th></tr></thead>
                <tbody id="liveBetsBody"></tbody>
            </table>
        </div>

        <div id="users" class="section">
            <h2>User Management</h2>
            <div style="margin-bottom:20px;">
                <input type="text" id="userSearch" placeholder="Search Phone Number...">
                <button class="btn btn-green" onclick="searchUser()">Search</button>
            </div>
            <table>
                <thead><tr><th>Phone</th><th>Balance</th><th>Vault</th><th>Status</th><th>Edit Balance</th><th>Action</th></tr></thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>

        <div id="wingo" class="section">
            <h2>WinGo Result Manipulation</h2>
            <div class="rig-box" style="background: #fff5f5;">
                <div>
                    <strong>Manual Control (Next Period)</strong><br>
                    <small>Force a specific result to maximize profit.</small>
                </div>
                <div>
                    <select id="forceMode"><option value="1">1 Min</option><option value="3">3 Min</option><option value="5">5 Min</option></select>
                    <select id="forceResult">
                        <option value="none">Auto (Min Loss)</option>
                        <option value="Red">Force Red</option>
                        <option value="Green">Force Green</option>
                        <option value="0">Force 0 (Violet/Red)</option>
                        <option value="5">Force 5 (Violet/Green)</option>
                    </select>
                    <button class="btn btn-red" onclick="applyForce()">Apply Force</button>
                </div>
            </div>
            <button class="btn btn-reset" onclick="resetAllRigging()">ONE-CLICK RESET ALL RIGGING</button>
        </div>

        <div id="slider" class="section">
            <h2>Slider Image Control</h2>
            <div class="slider-grid" id="sliderInputs"></div>
            <button class="btn btn-green" style="margin-top:20px; width:100%" onclick="saveSliderData()">Save Slider Settings</button>
        </div>

        <div id="transactions" class="section">
            <h2>Last 50 Transactions</h2>
            <div style="margin-bottom:15px;">
                <button class="btn btn-reset" style="width:auto" onclick="loadTx('deposits')">Deposits (Pending/Paid)</button>
                <button class="btn btn-reset" style="width:auto; background:#7f8c8d" onclick="loadTx('withdrawals')">Withdrawals (Pending/Paid)</button>
            </div>
            <table id="txTable">
                <thead id="txHead"></thead>
                <tbody id="txBody"></tbody>
            </table>
        </div>

        <div id="recharge" class="section">
            <h2>SIM Recharge Management</h2>
            <table>
                <thead><tr><th>Phone</th><th>Plan</th><th>Operator</th><th>Status</th><th>Action</th></tr></thead>
                <tbody id="rechargeBody"></tbody>
            </table>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const fbConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(fbConfig);
    const db = getDatabase(app);

    // Navigation
    window.showSection = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    // Calculate Admin Profit & User Loss
    onValue(ref(db, 'userBets'), (snap) => {
        let profit = 0; let loss = 0;
        snap.forEach(user => {
            user.forEach(bet => {
                const b = bet.val();
                if(b.status === 'loss') { profit += b.amount; loss += b.amount; }
                if(b.status === 'win') { profit -= (b.winAmount - b.amount); }
            });
        });
        document.getElementById('adminTotalProfit').innerText = "₹" + profit.toFixed(2);
        document.getElementById('userTotalLoss').innerText = "₹" + loss.toFixed(2);
    });

    // User Management
    onValue(ref(db, 'users'), (snap) => {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = "";
        snap.forEach(child => {
            const u = child.val();
            tbody.innerHTML += `<tr>
                <td>${u.phone}</td><td>₹${u.balance || 0}</td><td>₹${u.vault || 0}</td>
                <td><span class="badge ${u.banned?'btn-red':'btn-green'}">${u.banned?'Banned':'Active'}</span></td>
                <td><input type="number" id="bal_${u.phone}" style="width:60px"> 
                    <button class="btn btn-green" onclick="editBalance('${u.phone}',1)">+</button>
                    <button class="btn btn-red" onclick="editBalance('${u.phone}',-1)">-</button></td>
                <td><button class="btn btn-red" onclick="toggleBan('${u.phone}',${u.banned})">${u.banned?'Unban':'Ban'}</button></td>
            </tr>`;
        });
    });

    // Live Bets Tracking
    onValue(query(ref(db, 'userBets'), limitToLast(20)), (snap) => {
        const body = document.getElementById('liveBetsBody');
        body.innerHTML = "";
        snap.forEach(user => {
            user.forEach(bet => {
                const b = bet.val();
                body.innerHTML += `<tr><td>${user.key}</td><td>${b.mode}M</td><td>${b.type}</td><td>₹${b.amount}</td><td><span class="badge" style="background:#999">${b.status}</span></td></tr>`;
            });
        });
    });

    // Load Last 50 Transactions
    window.loadTx = (type) => {
        const head = document.getElementById('txHead');
        const body = document.getElementById('txBody');
        const txRef = query(ref(db, `requests/${type}`), limitToLast(50));
        
        if(type === 'deposits') {
            head.innerHTML = "<tr><th>Phone</th><th>Amount</th><th>Status</th><th>Time</th><th>Action</th></tr>";
            onValue(txRef, snap => {
                body.innerHTML = "";
                snap.forEach(c => {
                    const d = c.val();
                    body.innerHTML += `<tr><td>${d.phone}</td><td>₹${d.amount}</td>
                    <td><span class="badge ${d.status==='Paid'?'btn-green':'btn-red'}">${d.status}</span></td>
                    <td>${new Date(d.time).toLocaleDateString()}</td>
                    <td>${d.status!=='Paid'?`<button class="btn btn-green" onclick="updateTx('deposits','${c.key}','Paid','${d.phone}',${d.amount})">Approve</button>`:'--'}</td></tr>`;
                });
            });
        } else {
            head.innerHTML = "<tr><th>Phone</th><th>Bank Details</th><th>Amount</th><th>Status</th><th>Action</th></tr>";
            onValue(txRef, snap => {
                body.innerHTML = "";
                snap.forEach(c => {
                    const d = c.val();
                    body.innerHTML += `<tr><td>${d.phone}</td><td>Acc: ${d.accNum}<br>IFSC: ${d.ifsc}</td><td>₹${d.amount}</td>
                    <td><span class="badge ${d.status==='Paid'?'btn-green':'btn-red'}">${d.status}</span></td>
                    <td>${d.status!=='Paid'?`<button class="btn btn-red" onclick="updateTx('withdrawals','${c.key}','Paid')">Mark Paid</button>`:'--'}</td></tr>`;
                });
            });
        }
    };

    window.updateTx = async (path, id, status, phone, amt) => {
        await update(ref(db, `requests/${path}/${id}`), { status: status });
        if(path === 'deposits' && status === 'Paid') {
            const userRef = ref(db, `users/${phone}/balance`);
            const snap = await get(userRef);
            update(ref(db, `users/${phone}`), { balance: (snap.val() || 0) + amt });
        }
        alert("Transaction Updated!");
    };

    // Helper functions (Admin profit stats, slider loop, rigging)
    window.applyForce = () => {
        const m = document.getElementById('forceMode').value;
        const r = document.getElementById('forceResult').value;
        set(ref(db, `adminControl/wingo/${m}/forceNext`), r);
        alert("Next period result rigged!");
    };

    const sliderGrid = document.getElementById('sliderInputs');
    for(let i=1; i<=10; i++) {
        sliderGrid.innerHTML += `<div style="border:1px solid #ddd; padding:8px; border-radius:8px;">
        <strong>S${i}</strong> <input type="text" id="s_img_${i}" placeholder="Img URL" style="width:70px">
        <input type="text" id="s_url_${i}" placeholder="Redirect" style="width:70px"></div>`;
    }

    window.editBalance = async (ph, s) => {
        const a = parseFloat(document.getElementById('bal_'+ph).value); if(!a) return;
        const r = ref(db, `users/${ph}/balance`); const sn = await get(r);
        update(ref(db, `users/${ph}`), { balance: (sn.val()||0) + (a*s) });
    };

    window.showSection('dashboard');
</script>
</body>
</html>
