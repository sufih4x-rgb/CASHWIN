<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wingo Pro - Ultimate Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d93d3d; --green: #27ae60; --red: #c0392b; --violet: #8e44ad; --dark: #2c3e50; --bg: #f5f7fa; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; border-inline: 1px solid #ddd; }

        /* Header & Balance */
        .header-bg { background: linear-gradient(135deg, var(--primary), #b52b2b); padding: 20px; border-radius: 0 0 20px 20px; color: white; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-tag { font-size: 10px; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 10px; }
        .bal-amt { font-size: 32px; font-weight: 900; }

        /* Timer */
        .timer-card { background: white; margin: -20px 15px 15px; border-radius: 15px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 10; position: relative; }
        .timer-digits { font-size: 24px; font-weight: 900; color: var(--primary); }

        /* Tabs */
        .time-tabs { display: flex; padding: 0 15px; gap: 5px; margin-bottom: 15px; }
        .t-tab { flex: 1; padding: 8px; text-align: center; background: white; border: 1px solid #eee; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; color: #7f8c8d; }
        .t-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Game Board */
        .bet-area { padding: 0 15px; }
        .color-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .c-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; }
        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 10px; }
        .n-btn { aspect-ratio: 1; background: white; border: 1px solid #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; }
        .bg-g { color: var(--green); } .bg-r { color: var(--red); } .bg-v { color: var(--violet); }

        /* History Tables */
        .res-nav { display: flex; margin: 10px 15px; background: #fff; padding: 4px; border-radius: 10px; }
        .rn-btn { flex: 1; padding: 8px; border: none; background: none; font-size: 12px; font-weight: 600; border-radius: 8px; color: #999; }
        .rn-btn.active { background: #f0f2f5; color: var(--dark); }
        .h-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; background: white; }
        .h-table th { padding: 10px; color: #999; font-weight: 500; }
        .h-table td { padding: 12px; border-bottom: 1px solid #f9f9f9; }

        /* Chart */
        .chart-box { background: white; height: 260px; border-radius: 10px; margin: 0 15px; border: 1px solid #eee; }

        /* Modals */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 90%; max-width: 340px; border-radius: 20px; padding: 25px; text-align: center; }
        .amt-inp { width: 100%; border: 2px solid #eee; padding: 12px; border-radius: 10px; font-size: 20px; font-weight: bold; text-align: center; margin: 10px 0; }
        
        #lockOverlay { position: fixed; inset: 0; background: rgba(217, 61, 61, 0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body>

<div id="lockOverlay">
    <div style="font-size:60px; animation: bounce 1s infinite;">üîí</div>
    <div style="font-size:24px; font-weight:900; letter-spacing:2px;">STOP BETTING</div>
    <div id="lockTimer" style="font-size:50px; font-weight:900;">5</div>
</div>

<div id="authModal" class="modal-mask">
    <div class="modal-box">
        <h3>üîê Link Your Wallet</h3>
        <p style="color:#7f8c8d; font-size:12px; margin:10px 0 20px;">Use your registered mobile number.<br>Linking is locked for 72h after unlinking.</p>
        <input type="tel" id="userMobileInput" placeholder="Enter Mobile Number" class="amt-inp">
        <button onclick="attemptLogin()" style="width:100%; padding:15px; background:var(--dark); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ACCESS WALLET</button>
    </div>
</div>

<div class="header-bg">
    <div class="top-bar">
        <div>
            <span style="font-weight:900; font-size:20px;">WinGo Pro</span>
            <div id="linkedNumDisplay" class="user-tag">Not Linked</div>
        </div>
        <button onclick="unlink()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); color:white; padding:6px 12px; border-radius:8px; font-size:10px; font-weight:bold;">UNLINK</button>
    </div>
    <div style="font-size:12px; opacity:0.8;">Available Balance</div>
    <div class="bal-amt">‚Çπ<span id="balDisplay">0.00</span></div>
</div>

<div class="timer-card">
    <div>
        <div style="font-size:10px; color:#999; text-transform:uppercase;">Current Period</div>
        <div id="periodDisplay" style="font-weight:800; font-size:15px; color:var(--dark);">Loading...</div>
    </div>
    <div style="text-align:right;">
        <div style="font-size:10px; color:#999; text-transform:uppercase;">Time Remaining</div>
        <div class="timer-digits" id="timerDisplay">--:--</div>
    </div>
</div>

<div class="time-tabs">
    <div class="t-tab" id="m30" onclick="setMode(30)">30s</div>
    <div class="t-tab active" id="m60" onclick="setMode(60)">1m</div>
    <div class="t-tab" id="m180" onclick="setMode(180)">3m</div>
    <div class="t-tab" id="m300" onclick="setMode(300)">5m</div>
</div>

<div class="bet-area">
    <div class="color-group">
        <button class="c-btn" style="background:var(--green);" onclick="prepBet('Green')">GREEN</button>
        <button class="c-btn" style="background:var(--violet);" onclick="prepBet('Violet')">VIOLET</button>
        <button class="c-btn" style="background:var(--red);" onclick="prepBet('Red')">RED</button>
    </div>
    <div class="num-grid" id="numGrid"></div>
    <div style="display:flex; gap:10px;">
        <button class="c-btn" style="background:#f39c12;" onclick="prepBet('Big')">BIG</button>
        <button class="c-btn" style="background:#34495e;" onclick="prepBet('Small')">SMALL</button>
    </div>
</div>

<div class="res-nav">
    <button class="rn-btn active" onclick="showTab('hist')">Game History</button>
    <button class="rn-btn" onclick="showTab('chart')">Chart</button>
    <button class="rn-btn" onclick="showTab('mine')">My Bets</button>
</div>

<div id="tab-hist">
    <table class="h-table">
        <thead><tr><th>Period</th><th>Result</th><th>Size</th></tr></thead>
        <tbody id="histList"></tbody>
    </table>
</div>

<div id="tab-chart" style="display:none;">
    <div class="chart-box"><canvas id="chartCanvas"></canvas></div>
</div>

<div id="tab-mine" style="display:none;">
    <table class="h-table">
        <thead><tr><th>Selection</th><th>Amount</th><th>Status</th></tr></thead>
        <tbody id="myBetList"></tbody>
    </table>
</div>

<div id="betModal" class="modal-mask">
    <div class="modal-box">
        <h3 id="betTitle" style="color:var(--dark);">Join</h3>
        <input type="number" id="betAmtInput" value="10" class="amt-inp">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('betModal').style.display='none'" style="flex:1; padding:12px; border-radius:10px; border:1px solid #ddd; background:none;">Cancel</button>
            <button onclick="placeBet()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">CONFIRM BET</button>
        </div>
    </div>
</div>

<div id="resModal" class="modal-mask">
    <div class="modal-box" style="box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div id="resEmoji" style="font-size:60px; margin-bottom:10px;">üèÜ</div>
        <h2 id="resTitle" style="letter-spacing:1px;">YOU WON</h2>
        <div id="resAmt" style="font-size:36px; font-weight:900; margin:15px 0;">+ ‚Çπ0.00</div>
        <button onclick="document.getElementById('resModal').style.display='none'" style="width:100%; padding:15px; background:var(--dark); color:white; border:none; border-radius:12px; font-weight:bold;">CONTINUE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let CUR_USER = localStorage.getItem("WINGO_USER");
    let DEVICE_ID = localStorage.getItem("WINGO_DEV_ID") || "dev_"+Date.now();
    localStorage.setItem("WINGO_DEV_ID", DEVICE_ID);

    let userBal = 0, userStartBal = 0, startTime = Date.now(), depositCount = 0;
    let gameMode = 60, currentPeriod = "", selectedBet = "";

    // --- Wallet Security Logic ---
    if(CUR_USER) {
        document.getElementById('linkedNumDisplay').innerText = "ID: " + CUR_USER;
        initUser();
    } else {
        document.getElementById('authModal').style.display = 'flex';
    }

    window.attemptLogin = async () => {
        const num = document.getElementById('userMobileInput').value;
        if(num.length < 10) return alert("Enter valid register number");
        
        const uRef = ref(db, `users/${num}`);
        const snap = await get(uRef);
        
        if(snap.exists()){
            const d = snap.val();
            if(d.linkedDev && d.linkedDev !== DEVICE_ID){
                const hrsPassed = (Date.now() - (d.lastUnlink||0))/(1000*3600);
                if(hrsPassed < 72) return alert(`Security: Wait ${Math.ceil(72 - hrsPassed)} hours to switch devices.`);
            }
        }
        
        await update(uRef, { linkedDev: DEVICE_ID, lastLogin: Date.now() });
        localStorage.setItem("WINGO_USER", num);
        location.reload();
    };

    window.unlink = async () => {
        if(!confirm("Unlink device? Re-linking takes 72h.")) return;
        await update(ref(db, `users/${CUR_USER}`), { linkedDev: null, lastUnlink: Date.now() });
        localStorage.removeItem("WINGO_USER");
        location.reload();
    };

    function initUser() {
        onValue(ref(db, `users/${CUR_USER}`), (s) => {
            const d = s.val();
            userBal = d?.balance || 0;
            depositCount = d?.depositCount || 0;
            if(userStartBal === 0) userStartBal = userBal;
            document.getElementById('balDisplay').innerText = userBal.toFixed(2);
        });

        onValue(query(ref(db, `bets/${CUR_USER}`), limitToLast(10)), (s) => {
            if(!s.exists()) return;
            let html = "";
            Object.values(s.val()).reverse().forEach(b => {
                let clr = b.status==="Pending"?"#f39c12":(b.status==="Win"?"#27ae60":"#c0392b");
                html += `<tr><td>${b.select}</td><td>‚Çπ${b.amt}</td><td style="color:${clr};font-weight:bold">${b.status}</td></tr>`;
            });
            document.getElementById('myBetList').innerHTML = html;
        });
        startTimerSystem();
        loadHistory();
    }

    function startTimerSystem() {
        setInterval(() => {
            const now = new Date();
            const totalSec = Math.floor(now.getTime()/1000);
            const pId = totalSec - (totalSec % gameMode);
            const periodStr = `${now.getFullYear()}${now.getMonth()+1}${now.getDate()}${pId}`;
            
            if(currentPeriod !== periodStr) {
                if(currentPeriod !== "") resolvePeriod(currentPeriod);
                currentPeriod = periodStr;
            }
            document.getElementById('periodDisplay').innerText = periodStr;

            const rem = gameMode - (totalSec % gameMode);
            const min = Math.floor(rem/60);
            const sec = rem % 60;
            document.getElementById('timerDisplay').innerText = `0${min}:${sec<10?'0'+sec:sec}`;

            document.getElementById('lockOverlay').style.display = (rem <= 5) ? 'flex' : 'none';
            document.getElementById('lockTimer').innerText = rem;
        }, 1000);
    }

    async function resolvePeriod(pId) {
        const betRef = ref(db, `bets/${CUR_USER}/${pId}`);
        const bSnap = await get(betRef);
        let resNum = Math.floor(Math.random() * 10);

        if(bSnap.exists()) {
            const bet = bSnap.val();
            const rigSnap = await get(ref(db, 'admin/rigging'));
            const rig = rigSnap.val() || {};
            
            let outcome = "fair";
            if(rig.forceWin === CUR_USER) outcome = "win";
            else if(rig.forceLoss === CUR_USER) outcome = "loss";
            else {
                // Profit Protection Logic
                const profit = userBal - userStartBal;
                const hours = (Date.now() - startTime)/3600000;
                if(profit > 200 && hours < 3) outcome = Math.random() < 0.7 ? "loss" : "fair";
                else if(profit > 500 && hours < 7) outcome = Math.random() < 0.85 ? "loss" : "fair";
                else if(depositCount >= 2 && Math.random() < 0.25) outcome = "win"; // Allow some wins for depositors
            }

            if(outcome === "win") resNum = getWinner(bet.select);
            if(outcome === "loss") resNum = getLoser(bet.select);

            const isWin = checkWin(bet.select, resNum);
            let mult = (typeof bet.select === 'number' || bet.select === 'Violet') ? 4.8 : 1.92;
            
            if(isWin) {
                const winAmt = bet.amt * mult;
                await update(ref(db, `users/${CUR_USER}`), { balance: userBal + winAmt });
                await update(betRef, { status: "Win" });
                showResult(true, winAmt);
            } else {
                await update(betRef, { status: "Loss" });
                showResult(false, bet.amt);
            }
        }
        await set(ref(db, `history/${gameMode}/${pId}`), { num: resNum, period: pId });
        loadHistory();
    }

    const getWinner = (s) => (s === 'Green' ? 1 : s === 'Red' ? 2 : s === 'Big' ? 7 : 3);
    const getLoser = (s) => (s === 'Green' ? 4 : s === 'Red' ? 3 : s === 'Big' ? 2 : 8);

    function checkWin(sel, n) {
        if(sel === 'Green') return [1,3,7,9,5].includes(n);
        if(sel === 'Red') return [2,4,6,8,0].includes(n);
        if(sel === 'Violet') return [0,5].includes(n);
        if(sel === 'Big') return n >= 5;
        if(sel === 'Small') return n <= 4;
        return sel == n;
    }

    window.prepBet = (s) => {
        selectedBet = s;
        document.getElementById('betTitle').innerText = "Bet: " + s;
        document.getElementById('betModal').style.display = 'flex';
    };

    window.placeBet = async () => {
        const amt = parseInt(document.getElementById('betAmtInput').value);
        if(userBal < amt || amt < 1) return alert("Insufficient Balance");
        await update(ref(db, `users/${CUR_USER}`), { balance: userBal - amt });
        await set(ref(db, `bets/${CUR_USER}/${currentPeriod}`), { select: selectedBet, amt: amt, status: "Pending", period: currentPeriod });
        document.getElementById('betModal').style.display = 'none';
    };

    function showResult(win, amt) {
        const m = document.getElementById('resModal');
        document.getElementById('resTitle').innerText = win ? "WINNER" : "LOSS";
        document.getElementById('resTitle').style.color = win ? "#27ae60" : "#c0392b";
        document.getElementById('resAmt').innerText = (win?"+":"-") + " ‚Çπ" + amt.toFixed(2);
        document.getElementById('resEmoji').innerText = win ? "üèÜ" : "üò¢";
        m.style.display = 'flex';
    }

    function loadHistory() {
        onValue(query(ref(db, `history/${gameMode}`), limitToLast(15)), (s) => {
            if(!s.exists()) return;
            const data = Object.values(s.val()).reverse();
            let html = "";
            data.forEach(i => {
                const color = [1,3,7,9].includes(i.num) ? "var(--green)" : ([2,4,6,8].includes(i.num) ? "var(--red)" : "var(--violet)");
                html += `<tr><td>${i.period.slice(-4)}</td><td style="color:${color};font-weight:900">${i.num}</td><td>${i.num>=5?'Big':'Small'}</td></tr>`;
            });
            document.getElementById('histList').innerHTML = html;
            drawChart(Object.values(s.val()));
        });
    }

    function drawChart(data) {
        const cvs = document.getElementById('chartCanvas');
        const ctx = cvs.getContext('2d');
        cvs.width = cvs.parentElement.offsetWidth;
        cvs.height = 260;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        const sx = cvs.width / (data.length - 1);
        ctx.beginPath();
        ctx.strokeStyle = "#eee";
        data.forEach((d, i) => {
            const x = i * sx; const y = 240 - (d.num * 22);
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
        data.forEach((d, i) => {
            const x = i * sx; const y = 240 - (d.num * 22);
            ctx.beginPath(); ctx.arc(x, y, 4, 0, 7);
            ctx.fillStyle = [1,3,7,9].includes(d.num) ? "#27ae60" : "#c0392b";
            ctx.fill();
        });
    }

    const grid = document.getElementById('numGrid');
    for(let i=0; i<10; i++) {
        let c = [1,3,7,9].includes(i)?'bg-g':([2,4,6,8].includes(i)?'bg-r':'bg-v');
        grid.innerHTML += `<div class="n-btn ${c}" onclick="prepBet(${i})">${i}</div>`;
    }

    window.setMode = (m) => { 
        gameMode = m; 
        document.querySelectorAll('.t-tab').forEach(t=>t.classList.remove('active'));
        document.getElementById('m'+m).classList.add('active');
        loadHistory(); 
    };
    window.showTab = (id) => {
        ['tab-hist','tab-chart','tab-mine'].forEach(t=>document.getElementById(t).style.display='none');
        document.getElementById('tab-'+id).style.display = 'block';
        document.querySelectorAll('.rn-btn').forEach(b=>b.classList.toggle('active', b.onclick.toString().includes(id)));
    };
</script>
</body>
</html>
