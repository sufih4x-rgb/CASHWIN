<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASHWIN - Ultimate Control Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #ff4757; --green: #2ed573; --red: #ff4757; --violet: #a55eea; --gold: #ff9f43; --bg: #f8f9fc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); overflow-x: hidden; }

        /* Full Screen Lock */
        #fullScreenLock { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .lock-timer { font-size: 100px; font-weight: 900; color: var(--primary); text-shadow: 0 0 20px rgba(255,71,87,0.5); }

        /* Header & Wallet */
        .header-top { background: linear-gradient(135deg, #ff4757, #ff6b81); padding: 40px 20px 80px; color: white; border-radius: 0 0 50px 50px; text-align: center; }
        .wallet-box { background: white; margin: -60px 20px 20px; border-radius: 25px; padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        
        /* Game Tabs */
        .modes-container { display: flex; background: #eee; margin: 15px; border-radius: 15px; padding: 5px; gap: 5px; }
        .mode-btn { flex: 1; padding: 12px 5px; text-align: center; font-size: 11px; cursor: pointer; border-radius: 12px; color: #666; font-weight: bold; }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Timer Card */
        .timer-card { background: white; margin: 15px; border-radius: 20px; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary); }
        .time-rem { font-size: 24px; font-weight: 900; color: var(--primary); }

        /* Betting Grid */
        .betting-grid { background: white; margin: 15px; border-radius: 25px; padding: 20px; }
        .color-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-color { flex: 1; border: none; padding: 15px; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
        .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .btn-num { aspect-ratio: 1; border-radius: 50%; border: none; color: white; font-weight: bold; font-size: 18px; cursor: pointer; }

        /* SVG Chart & History */
        .chart-section { background: white; margin: 15px; border-radius: 20px; padding: 15px; position: relative; min-height: 450px; overflow: hidden; }
        #trendSvg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .history-table { width: 100%; border-collapse: collapse; position: relative; z-index: 10; }
        .history-table td { padding: 15px 0; text-align: center; border-bottom: 1px solid #f1f2f6; }
        .dot { width: 22px; height: 22px; border-radius: 50%; background: #f1f2f6; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; color: #999; }
        .dot.active { color: white; font-weight: bold; z-index: 20; position: relative; }

        /* My History Section */
        .my-bets-section { margin: 15px; background: white; border-radius: 20px; padding: 15px; }
        .bet-card { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }

        /* Win/Loss Popup (image_8251d0.png Style) */
        #resultPopup { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 100000; }
        .res-card { width: 320px; padding: 30px; border-radius: 30px; text-align: center; color: white; }
        .win-bg { background: linear-gradient(180deg, #ff8e53, #ff4757); }
        .loss-bg { background: linear-gradient(180deg, #57606f, #2f3542); }

        /* Gradients */
        .g-0 { background: linear-gradient(135deg, var(--red) 50%, var(--violet) 50%); }
        .g-5 { background: linear-gradient(135deg, var(--green) 50%, var(--violet) 50%); }
        .g-red { background: var(--red); }
        .g-green { background: var(--green); }
        
        #betPopup { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; z-index: 10000; transition: 0.4s; border-radius: 30px 30px 0 0; padding: 30px; box-shadow: 0 -10px 30px rgba(0,0,0,0.2); }
        #betPopup.open { bottom: 0; }
    </style>
</head>
<body>

<div id="fullScreenLock">
    <div class="lock-timer" id="lockDigit">5</div>
    <p>RESULT UPDATING...</p>
</div>

<div id="resultPopup">
    <div id="resCard" class="res-card">
        <h2 id="resTitle" style="font-size:28px;">Congratulations</h2>
        <div style="background:white; color:#333; border-radius:20px; padding:20px; margin:20px 0;">
            <p id="resSub" style="font-size:12px; color:#999;">Win Amount</p>
            <h1 id="resAmount" style="font-size:35px; color:var(--primary);">₹0.00</h1>
        </div>
        <button onclick="document.getElementById('resultPopup').style.display='none'" style="width:100%; padding:15px; border-radius:30px; border:none; background:white; font-weight:bold;">CLOSE</button>
    </div>
</div>

<div id="betPopup">
    <h3 id="betTargetDisplay" style="color:var(--primary);">Bet on: Green</h3>
    <input type="number" id="betAmount" value="10" min="1" max="100000" style="width:100%; padding:15px; margin:15px 0; border:2px solid #eee; border-radius:15px; font-size:20px; font-weight:bold;">
    <div style="display:flex; gap:10px;">
        <button onclick="closeBetPopup()" style="flex:1; padding:15px; border-radius:15px; border:none; background:#eee;">Cancel</button>
        <button onclick="confirmBet()" style="flex:1; padding:15px; border-radius:15px; border:none; background:var(--primary); color:white; font-weight:bold;">Confirm Bet</button>
    </div>
</div>

<div class="header-top"><h2>CASHWIN</h2></div>

<div class="wallet-box">
    <p style="font-size:13px; color:#888;">Wallet Balance</p>
    <h1 style="font-size:35px; margin:10px 0;">₹ <span id="uBal">0.00</span></h1>
    <div style="display:flex; gap:10px;">
        <button style="flex:1; padding:12px; border-radius:30px; border:none; background:var(--green); color:white; font-weight:bold;">Deposit</button>
        <button style="flex:1; padding:12px; border-radius:30px; border:1px solid #ddd; background:none; font-weight:bold;">Withdraw</button>
    </div>
</div>

<div class="modes-container" id="modeTabs">
    <div class="mode-btn active" onclick="changeMode('30s', this)">30s</div>
    <div class="mode-btn" onclick="changeMode('1m', this)">1m</div>
    <div class="mode-btn" onclick="changeMode('3m', this)">3m</div>
    <div class="mode-btn" onclick="changeMode('5m', this)">5m</div>
</div>

<div class="timer-card">
    <div><p style="font-size:11px; color:#999;">Period ID</p><div class="p-id" id="pIdDisplay">Loading...</div></div>
    <div style="text-align:right;"><p style="font-size:11px; color:#999;">Countdown</p><div class="time-rem" id="timer">00:00</div></div>
</div>

<div class="betting-grid">
    <div class="color-row">
        <button class="btn-color g-green" onclick="openBetPopup('Green')">Green</button>
        <button class="btn-color" style="background:var(--violet)" onclick="openBetPopup('Violet')">Violet</button>
        <button class="btn-color g-red" onclick="openBetPopup('Red')">Red</button>
    </div>
    <div class="num-grid" id="numGrid"></div>
</div>

<h3 style="margin:20px 15px 5px;">Trend Statistics</h3>
<div class="chart-section">
    <svg id="trendSvg"></svg>
    <table class="history-table">
        <tbody id="chartBody"></tbody>
    </table>
</div>

<h3 style="margin:20px 15px 5px;">My Betting History</h3>
<div class="my-bets-section" id="myHistoryBody">
    <p style="text-align:center; color:#999; padding:20px;">No bets placed yet.</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, set, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userId = localStorage.getItem("userId") || "U" + Math.floor(Math.random()*900000);
    localStorage.setItem("userId", userId);
    let currentMode = '30s';
    let currentBetTarget = "";

    // Build Grid
    const grid = document.getElementById('numGrid');
    for(let i=0; i<=9; i++) {
        let cls = i===0 ? 'g-0' : (i===5 ? 'g-5' : (i%2===0 ? 'g-red' : 'g-green'));
        grid.innerHTML += `<button class="btn-num ${cls}" onclick="openBetPopup(${i})">${i}</button>`;
    }

    // Chart Line Drawer
    function drawLine() {
        const svg = document.getElementById('trendSvg');
        const dots = document.querySelectorAll('.dot.active');
        if(dots.length < 2) return;
        let path = "";
        dots.forEach((dot, i) => {
            const rect = dot.getBoundingClientRect();
            const box = svg.getBoundingClientRect();
            const x = rect.left - box.left + (rect.width/2);
            const y = rect.top - box.top + (rect.height/2);
            path += (i === 0 ? 'M' : 'L') + `${x},${y} `;
        });
        svg.innerHTML = `<path d="${path}" fill="none" stroke="var(--primary)" stroke-width="2" />`;
    }

    // Timer Logic
    setInterval(() => {
        const now = new Date();
        const dur = (currentMode === '30s' ? 30 : 60);
        const rem = dur - (now.getSeconds() % dur);
        document.getElementById('timer').innerText = `00:${rem.toString().padStart(2,'0')}`;

        if(rem <= 5) {
            document.getElementById('fullScreenLock').style.display = 'flex';
            document.getElementById('lockDigit').innerText = rem;
        } else {
            document.getElementById('fullScreenLock').style.display = 'none';
        }

        const pId = "202512" + now.getDate() + String(Math.floor((now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds())/dur)).padStart(4,'0');
        document.getElementById('pIdDisplay').innerText = pId;
    }, 1000);

    // Sync Game & My Bets
    function sync() {
        // Balance
        onValue(ref(db, `users/${userId}/balance`), s => document.getElementById('uBal').innerText = (s.val()||0).toFixed(2));
        
        // Game History & Chart
        onValue(query(ref(db, `history/${currentMode}`), limitToLast(10)), snap => {
            const body = document.getElementById('chartBody');
            body.innerHTML = "";
            if(!snap.exists()) return;
            Object.values(snap.val()).reverse().forEach(item => {
                let row = `<tr><td style="font-size:10px; color:#999;">${item.pId.slice(-4)}</td>`;
                for(let i=0; i<=9; i++) {
                    let active = (item.n == i);
                    let clr = i===0?'g-0':(i===5?'g-5':(i%2==0?'g-red':'g-green'));
                    row += `<td><div class="dot ${active?'active '+clr:''}"> ${i} </div></td>`;
                }
                body.innerHTML += row + `</tr>`;
            });
            setTimeout(drawLine, 500);
        });

        // My Betting History
        onValue(query(ref(db, `myBets/${userId}`), limitToLast(10)), snap => {
            const myBody = document.getElementById('myHistoryBody');
            myBody.innerHTML = "";
            if(!snap.exists()) { myBody.innerHTML = "<p style='text-align:center;color:#999;'>No history.</p>"; return; }
            Object.values(snap.val()).reverse().forEach(bet => {
                myBody.innerHTML += `
                    <div class="bet-card">
                        <div><b>${bet.target}</b><br><small>${bet.pId}</small></div>
                        <div style="text-align:right">
                            <span style="color:${bet.status=='Win'?'var(--green)':'var(--red)'}">₹${bet.amount}</span><br>
                            <small>${bet.status}</small>
                        </div>
                    </div>`;
            });
        });
    }

    window.openBetPopup = (t) => {
        currentBetTarget = t;
        document.getElementById('betTargetDisplay').innerText = "Bet on: " + t;
        document.getElementById('betPopup').classList.add('open');
    };

    window.closeBetPopup = () => document.getElementById('betPopup').classList.remove('open');

    window.confirmBet = async () => {
        const amt = parseInt(document.getElementById('betAmount').value);
        if(amt < 1) return alert("Min ₹1");
        const s = await get(ref(db, `users/${userId}/balance`));
        const bal = s.val() || 0;
        if(bal < amt) return alert("Low Balance");

        await update(ref(db, `users/${userId}`), { balance: bal - amt });
        const pId = document.getElementById('pIdDisplay').innerText;
        await set(ref(db, `myBets/${userId}/${pId}`), {
            pId, target: currentBetTarget, amount: amt, status: 'Pending', mode: currentMode
        });
        alert("Bet Success!");
        closeBetPopup();
    };

    window.changeMode = (m, el) => {
        currentMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        sync();
    };

    // Show Win/Loss Popup Hook (Can be triggered by Admin result)
    window.showResult = (isWin, amount) => {
        const card = document.getElementById('resCard');
        const popup = document.getElementById('resultPopup');
        if(isWin) {
            card.className = "res-card win-bg";
            document.getElementById('resTitle').innerText = "Congratulations";
            document.getElementById('resAmount').innerText = "₹" + amount.toFixed(2);
            document.getElementById('resAmount').style.color = "var(--primary)";
        } else {
            card.className = "res-card loss-bg";
            document.getElementById('resTitle').innerText = "Better Luck Next Time";
            document.getElementById('resAmount').innerText = "₹" + amount.toFixed(2);
            document.getElementById('resAmount').style.color = "#666";
        }
        popup.style.display = "flex";
    };

    sync();
    window.addEventListener('resize', drawLine);
</script>
</body>
</html>
