<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko Pro - Admin Control Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f212e;
            --card: #1a2c38;
            --primary: #00e701;
            --red: #ff4444;
            --yellow: #f1c40f;
            --blue: #2f4553;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; user-select: none; }
        body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }

        .header { width: 100%; max-width: 500px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card); border-bottom: 2px solid var(--blue); position: sticky; top: 0; z-index: 1000; }
        .bal-amt { color: var(--primary); font-weight: 900; font-size: 1.4rem; text-shadow: 0 0 10px rgba(0,231,1,0.3); }
        .user-id { font-size: 10px; color: #9aa; background: #0f212e; padding: 2px 8px; border-radius: 4px; display: inline-block; }

        #game-area { position: relative; width: 100%; max-width: 500px; height: 460px; background: radial-gradient(circle, #1a2c38 0%, #0f212e 100%); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        /* WIN/LOSS ANIMATION */
        #result-toast { 
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            padding: 15px 35px; border-radius: 12px; font-weight: 900; font-size: 1.8rem;
            display: none; z-index: 1001; text-align: center;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            pointer-events: none;
        }
        .animate-pop { animation: popResult 0.6s forwards; }
        @keyframes popResult { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -60%) scale(1); opacity: 0; }
        }

        #buckets-container { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; width: 94%; justify-content: center; }
        .bucket { flex: 1; height: 26px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; color: #000; transition: 0.2s; }
        .bucket.hit { transform: scale(1.3); filter: brightness(1.8); }

        .controls { width: 100%; max-width: 500px; padding: 20px; background: var(--card); border-radius: 24px 24px 0 0; }
        .bet-box { background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--blue); display: flex; align-items: center; margin-bottom: 15px; }
        .bet-input { background: transparent; border: none; color: white; font-size: 18px; font-weight: 700; width: 100%; outline: none; }
        
        .btn-row { display: flex; gap: 10px; }
        .drop-btn { flex: 1; padding: 16px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .btn-green { background: var(--primary); box-shadow: 0 4px 0 #00a001; }
        .btn-yellow { background: var(--yellow); box-shadow: 0 4px 0 #c29d0b; }
        .btn-red { background: var(--red); color: #fff; box-shadow: 0 4px 0 #b32d2d; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: var(--card); width: 85%; max-width: 350px; padding: 30px; border-radius: 24px; text-align: center; }
        .m-input { width: 100%; padding: 15px; background: var(--bg); border: 1px solid var(--blue); border-radius: 12px; color: white; font-size: 1.2rem; margin: 20px 0; text-align: center; }
        
        .history-section { width: 100%; max-width: 500px; padding: 15px; background: var(--bg); }
        .hist-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--blue); font-size: 12px; }
    </style>
</head>
<body>

<div id="result-toast"></div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary);">LINK WALLET</h2>
        <input type="tel" id="mobileInput" placeholder="Phone Number" class="m-input" maxlength="10">
        <button onclick="linkWallet()" class="drop-btn btn-green" style="width: 100%;">CONNECT NOW</button>
    </div>
</div>

<div class="header">
    <div>
        <div id="userDisplay" class="user-id">Guest User</div><br>
        <button onclick="unlinkDevice()" style="background:none; border:none; color:var(--red); font-size:9px; cursor:pointer;">UNLINK DEVICE</button>
    </div>
    <div class="bal-container">
        <div class="bal-amt">₹<span id="displayBal">0.00</span></div>
    </div>
    <div id="profitTag" style="font-size: 10px; color: var(--yellow);">Session: ₹0</div>
</div>

<div id="game-area">
    <canvas id="plinkoCanvas"></canvas>
    <div id="buckets-container"></div>
</div>

<div class="controls">
    <div class="bet-box">
        <input type="number" id="betAmount" value="10" class="bet-input">
        <span style="font-weight:900; color:var(--primary)">₹</span>
    </div>
    <div class="btn-row">
        <button onclick="dropBall('green')" class="drop-btn btn-green">Low</button>
        <button onclick="dropBall('yellow')" class="drop-btn btn-yellow">Med</button>
        <button onclick="dropBall('red')" class="drop-btn btn-red">High</button>
    </div>
</div>

<div class="history-section">
    <div id="gameHistory"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let CUR_USER = localStorage.getItem("PLINKO_USER");
    let DEVICE_ID = localStorage.getItem("PLINKO_DEV_ID") || "dev_" + Math.random().toString(36).slice(2, 12);
    localStorage.setItem("PLINKO_DEV_ID", DEVICE_ID);

    let balance = 0, sessionProfit = 0, startTime = Date.now();
    const mults = {
        green:  [11, 3.2, 1.6, 1.2, 1.1, 1, 0.5, 1, 1.1, 1.2, 1.6, 3.2, 11],
        yellow: [25, 10, 5, 2, 1, 0.5, 0.2, 0.5, 1, 2, 5, 10, 25],
        red:    [100, 50, 10, 5, 2, 0.5, 0, 0.5, 2, 5, 10, 50, 100]
    };

    // --- Matter.js Setup ---
    const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
    const engine = Engine.create();
    const canvas = document.getElementById('plinkoCanvas');
    const render = Render.create({
        canvas: canvas,
        engine: engine,
        options: { width: 500, height: 460, wireframes: false, background: 'transparent' }
    });

    // Boundaries
    Composite.add(engine.world, [
        Bodies.rectangle(10, 230, 20, 460, { isStatic: true, render: { visible: false } }),
        Bodies.rectangle(490, 230, 20, 460, { isStatic: true, render: { visible: false } })
    ]);

    // Pegs
    for (let i = 0; i < 12; i++) {
        for (let j = 0; j <= i; j++) {
            Composite.add(engine.world, Bodies.circle(250 + (j - i / 2) * 32, 50 + i * 32, 3, { isStatic: true, render: { fillStyle: '#4a5d6a' } }));
        }
    }

    Render.run(render);
    Runner.run(Runner.create(), engine);

    // --- Firebase & Wallet ---
    async function validateSession() {
        if (!CUR_USER) { document.getElementById('authModal').style.display = 'flex'; return; }
        const snap = await get(ref(db, `users/${CUR_USER}`));
        if (snap.exists() && snap.val().linkedDev === DEVICE_ID) { initUser(); } 
        else { document.getElementById('authModal').style.display = 'flex'; }
    }

    window.linkWallet = async () => {
        const phone = document.getElementById('mobileInput').value;
        if (phone.length < 10) return alert("Invalid Number");
        const uRef = ref(db, `users/${phone}`);
        const snap = await get(uRef);
        if (snap.exists()) {
            const d = snap.val();
            if (d.linkedDev && d.linkedDev !== DEVICE_ID) {
                const diff = Date.now() - (d.lastUnlink || 0);
                if (diff < 259200000) return alert("Device Locked to another user.");
            }
        }
        await update(uRef, { linkedDev: DEVICE_ID, online: true });
        localStorage.setItem("PLINKO_USER", phone);
        location.reload();
    };

    window.unlinkDevice = async () => {
        await update(ref(db, `users/${CUR_USER}`), { linkedDev: null, lastUnlink: Date.now() });
        localStorage.removeItem("PLINKO_USER");
        location.reload();
    };

    function initUser() {
        onValue(ref(db, `users/${CUR_USER}`), (s) => {
            balance = s.val()?.balance || 0;
            document.getElementById('displayBal').innerText = balance.toFixed(2);
            document.getElementById('userDisplay').innerText = "ID: " + CUR_USER;
        });
        renderBuckets('green');
    }

    function renderBuckets(risk) {
        const container = document.getElementById('buckets-container');
        container.innerHTML = '';
        const colors = { green: '#00e701', yellow: '#f1c40f', red: '#ff4444' };
        mults[risk].forEach((m, i) => {
            const b = document.createElement('div');
            b.className = 'bucket'; b.id = `bucket-${i}`;
            b.style.backgroundColor = colors[risk];
            b.innerText = m + 'x';
            container.appendChild(b);
        });
    }

    function triggerResultAnim(win, bet) {
        const t = document.getElementById('result-toast');
        t.style.display = 'block';
        t.className = 'animate-pop';
        
        if (win > bet) {
            t.style.background = 'rgba(0, 231, 1, 0.9)';
            t.style.color = '#000';
            t.innerHTML = `BIG WIN<br>₹${win.toFixed(2)}`;
        } else {
            t.style.background = 'rgba(255, 68, 68, 0.9)';
            t.style.color = '#fff';
            t.innerHTML = `LOSS<br>₹${bet.toFixed(2)}`;
        }
        setTimeout(() => { t.style.display = 'none'; t.className = ''; }, 1200);
    }

    window.dropBall = async (risk) => {
        const betValue = parseFloat(document.getElementById('betAmount').value);
        if (isNaN(betValue) || betValue < 1 || betValue > balance) return;

        renderBuckets(risk);
        balance -= betValue;
        await update(ref(db, `users/${CUR_USER}`), { balance: balance });

        const rig = (await get(ref(db, 'admin/rigging'))).val() || {};
        const playedHrs = (Date.now() - startTime) / 3600000;

        let forceX = (Math.random() - 0.5) * 4;
        if (rig.forceLoss === CUR_USER) forceX = Math.random() > 0.5 ? 12 : -12;
        else if (rig.forceWin === CUR_USER) forceX = (Math.random() - 0.5) * 0.1;
        else if ((sessionProfit > 200 && playedHrs < 3)) forceX = Math.random() > 0.5 ? 10 : -10;

        const ball = Bodies.circle(250 + forceX, 10, 6, {
            restitution: 0.5, friction: 0.01,
            render: { fillStyle: risk === 'red' ? '#ff4444' : (risk === 'yellow' ? '#f1c40f' : '#00e701') }
        });

        Composite.add(engine.world, ball);

        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach(async (pair) => {
                if ((pair.bodyA === ball || pair.bodyB === ball) && ball.position.y > 410) {
                    const boardWidth = 420; 
                    const startX = 250 - (boardWidth / 2);
                    let idx = Math.floor((ball.position.x - startX) / (boardWidth / 13));
                    idx = Math.max(0, Math.min(idx, 12));

                    const multiplier = mults[risk][idx];
                    const winAmount = betValue * multiplier;

                    Composite.remove(engine.world, ball);

                    // INSTANT CREDIT TO WALLET
                    balance += winAmount;
                    sessionProfit += (winAmount - betValue);
                    await update(ref(db, `users/${CUR_USER}`), { balance: balance });

                    // UI ANIMATIONS
                    document.getElementById('profitTag').innerText = `Session: ₹${sessionProfit.toFixed(0)}`;
                    triggerResultAnim(winAmount, betValue);
                    
                    const bucket = document.getElementById(`bucket-${idx}`);
                    if(bucket) { bucket.classList.add('hit'); setTimeout(()=>bucket.classList.remove('hit'), 300); }

                    // LOGGING
                    set(ref(db, `admin/tracking/${CUR_USER}/${Date.now()}`), { bet: betValue, win: winAmount, mult: multiplier });
                    addHistory(risk, multiplier, winAmount);
                }
            });
        });
    };

    function addHistory(r, m, w) {
        const h = document.getElementById('gameHistory');
        const item = `<div class="hist-item">
            <span style="color:${w > 0 ? 'var(--primary)' : 'var(--red)'}">${r.toUpperCase()}</span>
            <span>${m}x</span>
            <span style="font-weight:bold;">₹${w.toFixed(2)}</span>
        </div>`;
        h.innerHTML = item + h.innerHTML;
        if(h.children.length > 5) h.removeChild(h.lastChild);
    }

    validateSession();
</script>
</body>
</html>
