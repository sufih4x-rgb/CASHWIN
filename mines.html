<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Mines Pro - CASHWIN</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --accent: #fbbf24; --danger: #ef4444; --success: #22c55e; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        body { background: var(--bg); color: white; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        .container { width: 100%; max-width: 450px; padding: 15px; }

        .header { display: flex; justify-content: space-between; align-items: center; background: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 20px; }
        .balance-amt { font-size: 20px; font-weight: 900; color: var(--accent); }

        /* Grid & Animations */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .slot { 
            aspect-ratio: 1; background: #1e293b; border-radius: 10px; border: 2px solid #334155; 
            display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.3s;
        }
        .slot:active { transform: scale(0.9); }
        .slot.revealed { transform: rotateY(180deg); background: #2d3748; }
        .slot.diamond { color: var(--accent); animation: glow 1s infinite alternate; }
        .slot.bomb { color: var(--danger); animation: shake 0.2s infinite; }

        @keyframes glow { from { text-shadow: 0 0 5px #fff; } to { text-shadow: 0 0 15px var(--accent); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, 1px); } }

        .controls { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        input { width: 100%; padding: 15px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 12px; margin-bottom: 15px; text-align: center; font-size: 20px; font-weight: bold; }
        
        .btn-stack { display: flex; gap: 10px; }
        .main-btn { flex: 2; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .cashout-btn { flex: 1; padding: 15px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: none; }
        
        .disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div><small style="color: #94a3b8;">CASHWIN MINES</small><br><span id="userMobile">+91 0000000000</span></div>
        <div style="text-align: right;"><small style="opacity: 0.7;">WALLET</small><br><div class="balance-amt">₹<span id="balDisplay">0.00</span></div></div>
    </div>

    <div class="grid" id="mineGrid"></div>

    <div class="controls">
        <div style="text-align: center; margin-bottom: 10px;">
            <span id="multiTag" style="background: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 12px;">Multiplier: 1.00x</span>
        </div>
        <input type="number" id="betInput" value="100">
        <div class="btn-stack">
            <button class="main-btn" id="startBtn" onclick="startGame()">BET</button>
            <button class="cashout-btn" id="cashBtn" onclick="cashOut()">CASHOUT</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const userId = localStorage.getItem('userPhone') || '9117748052'; // Default for testing

    let currentBalance = 0;
    let gameActive = false;
    let currentMultiplier = 1.00;
    let betAmount = 0;
    let userRigging = "normal";

    function initApp() {
        db.ref("users/" + userId).on('value', (snap) => {
            const data = snap.val();
            if (data) {
                currentBalance = data.balance || 0;
                userRigging = data.rig || "normal"; // Matches Admin "rig" field
                document.getElementById("balDisplay").innerText = currentBalance.toFixed(2);
                document.getElementById("userMobile").innerText = "+91 " + data.phone;
            }
        });
        createGrid();
    }

    function createGrid() {
        const grid = document.getElementById("mineGrid");
        grid.innerHTML = '';
        grid.classList.remove("disabled");
        for (let i = 0; i < 25; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.onclick = () => revealSlot(slot);
            grid.appendChild(slot);
        }
    }

    window.startGame = function() {
        betAmount = Number(document.getElementById("betInput").value);
        if (betAmount < 10) return alert("Minimum bet ₹10");
        if (betAmount > currentBalance) return alert("Insufficient Balance!");

        // Update Balance in DB
        db.ref("users/" + userId).update({ balance: currentBalance - betAmount })
        .then(() => {
            gameActive = true;
            currentMultiplier = 1.00;
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("cashBtn").style.display = "block";
            document.getElementById("betInput").disabled = true;
            document.getElementById("cashBtn").innerText = `CASHOUT (₹${betAmount})`;
            createGrid();
        })
        .catch(e => alert("Betting Error: " + e.message));
    }

    function revealSlot(slot) {
        if (!gameActive || slot.classList.contains('revealed')) return;

        let isBomb = false;
        
        // ADMIN RIGGING LOGIC
        if (userRigging === "loss") {
            isBomb = true; // Always bomb if rigged to lose
        } else if (userRigging === "win") {
            isBomb = false; // Never bomb if rigged to win
        } else {
            isBomb = Math.random() < 0.20; // 20% Chance for bomb
        }

        slot.classList.add('revealed');

        if (isBomb) {
            slot.innerHTML = '<i class="fas fa-bomb"></i>';
            slot.classList.add('bomb');
            gameOver(false);
        } else {
            slot.innerHTML = '<i class="fas fa-gem"></i>';
            slot.classList.add('diamond');
            // SLOW PROFIT: Only 0.05 increase per diamond
            currentMultiplier += 0.05; 
            document.getElementById("multiTag").innerText = `Multiplier: ${currentMultiplier.toFixed(2)}x`;
            document.getElementById("cashBtn").innerText = `CASHOUT (₹${(betAmount * currentMultiplier).toFixed(2)})`;
        }
    }

    window.cashOut = function() {
        if (!gameActive) return;
        const winAmt = betAmount * currentMultiplier;
        db.ref("users/" + userId).update({ balance: currentBalance + winAmt });
        alert(`Cashout Success! You won ₹${winAmt.toFixed(2)}`);
        gameOver(true);
    }

    function gameOver(win) {
        gameActive = false;
        document.getElementById("mineGrid").classList.add("disabled");
        document.getElementById("startBtn").style.display = "block";
        document.getElementById("cashBtn").style.display = "none";
        document.getElementById("betInput").disabled = false;
        if (!win) alert("BOMB! Game Over.");
    }

    initApp();
</script>
</body>
</html>
