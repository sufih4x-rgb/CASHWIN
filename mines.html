<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mines Pro - Control Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f212e;
            --card: #1a2c38;
            --primary: #00e701;
            --red: #ff4444;
            --blue: #2f4553;
            --text: #ffffff;
            --accent: #f1c40f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; overflow-x: hidden; }

        .top-nav { width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-radius: 12px; margin-bottom: 15px; border-bottom: 3px solid rgba(0,0,0,0.2); }
        .bal-amt { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        .user-tag { font-size: 10px; color: #9aa; background: #0f212e; padding: 2px 6px; border-radius: 4px; }

        .game-container { width: 100%; max-width: 450px; background: var(--card); padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .mode-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: var(--bg); padding: 5px; border-radius: 10px; }
        .m-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #9aa; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 11px; }
        .m-btn.active { background: var(--blue); color: white; }

        .mine-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .tile { 
            aspect-ratio: 1; background: var(--blue); border-radius: 8px; 
            border-bottom: 4px solid rgba(0,0,0,0.4); cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.8rem; transition: 0.1s; 
        }
        .tile.revealed-diamond { background: var(--primary); border-bottom: none; box-shadow: inset 0 0 15px rgba(0,0,0,0.3); animation: pop 0.2s; }
        .tile.revealed-mine { background: var(--red); border-bottom: none; animation: shake 0.2s; }
        .tile.fade { opacity: 0.4; }

        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translateX(3px); } 50% { transform: translateX(-3px); } 100% { transform: translateX(0); } }

        .input-group { background: var(--bg); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--blue); }
        .label { font-size: 10px; color: #9aa; text-transform: uppercase; margin-bottom: 4px; }
        .bet-input { width: 100%; background: transparent; border: none; color: white; font-size: 18px; font-weight: 900; outline: none; }
        
        .main-btn { width: 100%; padding: 16px; border: none; border-radius: 10px; background: var(--primary); color: #000; font-weight: 900; font-size: 16px; cursor: pointer; }
        .main-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .main-btn.cashout { background: var(--accent); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: var(--card); width: 85%; max-width: 320px; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--primary); }

        .history-row { display: flex; justify-content: space-between; font-size: 11px; color: #9aa; margin-top: 15px; border-top: 1px solid var(--blue); padding-top: 10px; }
    </style>
</head>
<body>

<div id="authModal" class="modal">
    <div class="modal-content" style="border-color: var(--blue);">
        <h2 style="color:var(--primary); margin-bottom: 10px;">Link Wallet</h2>
        <p style="font-size: 12px; color: #9aa; margin-bottom: 15px;">Enter your registered mobile number to sync balance.</p>
        <input type="tel" id="mobileInput" placeholder="Mobile Number" style="width:100%; padding:15px; background:var(--bg); border:1px solid var(--blue); border-radius:10px; color:white; font-size:18px; text-align:center; margin-bottom:15px;" maxlength="10">
        <button onclick="linkWallet()" class="main-btn">CONNECT WALLET</button>
    </div>
</div>

<div class="top-nav">
    <div>
        <div id="userIdTag" class="user-tag">Guest</div>
        <div class="bal-amt">â‚¹<span id="displayBal">0.00</span></div>
    </div>
    <button onclick="unlinkDevice()" style="background:var(--red); border:none; color:white; padding:6px 12px; border-radius:6px; font-size:10px; font-weight:bold; cursor:pointer;">UNLINK</button>
</div>

<div class="game-container">
    <div class="mode-tabs">
        <button class="m-btn active" id="mode-easy" onclick="setDifficulty('easy')">EASY (3M)</button>
        <button class="m-btn" id="mode-medium" onclick="setDifficulty('medium')">MED (10M)</button>
        <button class="m-btn" id="mode-hard" onclick="setDifficulty('hard')">HARD (24M)</button>
    </div>

    <div class="mine-grid" id="grid"></div>

    <div class="input-group">
        <div class="label">Bet Amount (â‚¹)</div>
        <input type="number" id="betAmount" value="10" class="bet-input" min="1">
    </div>

    <div id="multiDisplay" style="text-align:center; margin-bottom:10px; font-weight:900; color:var(--accent); display:none; font-size: 14px;">
        CURRENT: <span id="currMulti">1.00x</span> | NEXT: <span id="nextMulti">1.23x</span>
    </div>

    <button id="actionBtn" onclick="handleMainAction()" class="main-btn">START GAME</button>
    
    <div class="history-row">
        <span>Session Profit: â‚¹<span id="sessionProfit">0.00</span></span>
    </div>
</div>

<div id="winModal" class="modal">
    <div class="modal-content">
        <div style="font-size: 60px;">ðŸ’Ž</div>
        <h1 style="color:var(--primary); margin: 10px 0;">CASHED OUT!</h1>
        <div style="font-size: 28px; font-weight:900; margin-bottom: 20px; color: white;">â‚¹<span id="winAmountDisplay">0.00</span></div>
        <button onclick="closeModals()" class="main-btn">COLLECT</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://testing-26b8c-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- KEY LOGIC: Detect Wallet Activation from wallet.html ---
    let CUR_USER = localStorage.getItem("MINE_USER");
    let WALLET_ACTIVE = localStorage.getItem("WALLET_ACTIVE") === "true"; // Added this
    let DEVICE_ID = localStorage.getItem("MINE_DEV_ID") || "dev_" + Math.random().toString(36).slice(2, 10);
    localStorage.setItem("MINE_DEV_ID", DEVICE_ID);

    let balance = 0, sessionProfit = 0, startTime = Date.now();
    let currentMode = 'easy';
    let isGameActive = false, revealedCount = 0, currentBet = 0;

    const easyMults = [1, 1.23, 1.33, 1.45, 1.62, 1.85, 2.15, 2.60, 3.20, 4.05, 5.25, 7.10, 10.2, 15.5, 25.0, 42.0, 78.0, 160.0, 380.0, 1050.0];
    const medMults = [2.40, 6.20, 18.5, 62.0, 240.0, 1100.0];
    const hardMults = [24.5];

    // --- Auto-Access System (Updated to check wallet.html status) ---
    async function checkAutoLogin() {
        // If WALLET_ACTIVE is true in localStorage, we bypass login if we have a user
        if (WALLET_ACTIVE && CUR_USER) {
            const snap = await get(ref(db, `users/${CUR_USER}`));
            if (snap.exists() && snap.val().linkedDev === DEVICE_ID) {
                document.getElementById('authModal').style.display = 'none';
                initUser();
                return;
            }
        }
        
        // Default login check if not automatically bypassed
        if (!CUR_USER) {
            document.getElementById('authModal').style.display = 'flex';
        } else {
            const snap = await get(ref(db, `users/${CUR_USER}`));
            if (snap.exists() && snap.val().linkedDev === DEVICE_ID) {
                document.getElementById('authModal').style.display = 'none';
                initUser();
            } else {
                localStorage.removeItem("MINE_USER");
                document.getElementById('authModal').style.display = 'flex';
            }
        }
    }

    window.linkWallet = async () => {
        const phone = document.getElementById('mobileInput').value;
        if (phone.length < 10) return alert("Invalid Number");
        
        const uRef = ref(db, `users/${phone}`);
        const snap = await get(uRef);
        
        if (snap.exists()) {
            const d = snap.val();
            if (d.linkedDev && d.linkedDev !== DEVICE_ID) {
                const diff = Date.now() - (d.lastUnlink || 0);
                if (diff < 259200000) return alert("Account locked to another device. Wait 3 days.");
            }
        } else {
            return alert("Number not registered in system.");
        }

        await update(uRef, { linkedDev: DEVICE_ID, online: true });
        localStorage.setItem("MINE_USER", phone);
        localStorage.setItem("WALLET_ACTIVE", "true"); // Sync status
        location.reload();
    };

    window.unlinkDevice = async () => {
        if (!confirm("Unlink device? (3-day lock for other devices)")) return;
        await update(ref(db, `users/${CUR_USER}`), { linkedDev: null, lastUnlink: Date.now(), online: false });
        localStorage.removeItem("MINE_USER");
        localStorage.removeItem("WALLET_ACTIVE");
        location.reload();
    };

    function initUser() {
        onValue(ref(db, `users/${CUR_USER}`), (s) => {
            const d = s.val();
            balance = d?.balance || 0;
            document.getElementById('displayBal').innerText = balance.toFixed(2);
            document.getElementById('userIdTag').innerText = "ID: " + CUR_USER;
        });
        createGrid();
    }

    function createGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.onclick = () => clickTile(i, tile);
            grid.appendChild(tile);
        }
    }

    window.setDifficulty = (mode) => {
        if (isGameActive) return;
        currentMode = mode;
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
    };

    window.handleMainAction = () => {
        if (!isGameActive) startGame();
        else cashout();
    };

    async function startGame() {
        currentBet = parseFloat(document.getElementById('betAmount').value);
        if (isNaN(currentBet) || currentBet > balance || currentBet < 1) return alert("Invalid Balance");

        balance -= currentBet;
        await update(ref(db, `users/${CUR_USER}`), { balance: balance });
        
        set(ref(db, `admin/tracking/${CUR_USER}/last_action`), { type: 'START', amount: currentBet, time: Date.now() });

        isGameActive = true;
        revealedCount = 0;
        createGrid();
        
        const btn = document.getElementById('actionBtn');
        btn.innerText = 'CASHOUT (â‚¹0.00)';
        btn.classList.add('cashout');
        document.getElementById('multiDisplay').style.display = 'block';
        updateMultiUI();
    }

    async function clickTile(index, el) {
        if (!isGameActive || el.classList.contains('revealed-diamond')) return;

        const rigSnap = await get(ref(db, 'admin/rigging'));
        const rig = rigSnap.val() || {};
        const hoursPlayed = (Date.now() - startTime) / 3600000;

        let isMine = false;
        
        if (rig.forceLoss === CUR_USER) {
            isMine = true;
        } else if (rig.forceWin === CUR_USER) {
            isMine = false;
        } else {
            // Profit Control (6-7 Hours for â‚¹500-â‚¹700)
            if (sessionProfit > 500 && hoursPlayed < 6) {
                isMine = Math.random() < 0.90; 
            } else {
                const mineTarget = currentMode === 'easy' ? 3 : (currentMode === 'medium' ? 10 : 24);
                isMine = Math.random() < (mineTarget / (25 - revealedCount));
            }
        }

        if (isMine) {
            el.innerHTML = "ðŸ’£";
            el.classList.add('revealed-mine');
            gameOver(false);
        } else {
            revealedCount++;
            el.innerHTML = "ðŸ’Ž";
            el.classList.add('revealed-diamond');
            
            const currentMulti = getMulti(revealedCount);
            document.getElementById('actionBtn').innerText = `CASHOUT (â‚¹${(currentBet * currentMulti).toFixed(2)})`;
            updateMultiUI();
        }
    }

    async function cashout() {
        if (!isGameActive || revealedCount === 0) return;
        const winTotal = currentBet * getMulti(revealedCount);
        
        balance += winTotal;
        sessionProfit += (winTotal - currentBet);
        
        await update(ref(db, `users/${CUR_USER}`), { balance: balance });
        
        set(ref(db, `admin/tracking/${CUR_USER}/transactions/${Date.now()}`), {
            type: 'WIN',
            bet: currentBet,
            win: winTotal,
            mode: currentMode,
            time: new Date().toLocaleString()
        });

        document.getElementById('winAmountDisplay').innerText = winTotal.toFixed(2);
        document.getElementById('winModal').style.display = 'flex';
        document.getElementById('sessionProfit').innerText = sessionProfit.toFixed(2);
        gameOver(true);
    }

    function gameOver(win) {
        isGameActive = false;
        document.getElementById('actionBtn').innerText = 'START GAME';
        document.getElementById('actionBtn').classList.remove('cashout');
        document.getElementById('multiDisplay').style.display = 'none';

        if (!win) {
            set(ref(db, `admin/tracking/${CUR_USER}/transactions/${Date.now()}`), {
                type: 'LOSS',
                bet: currentBet,
                time: new Date().toLocaleString()
            });
        }

        document.querySelectorAll('.tile').forEach(t => {
            if (!t.classList.contains('revealed-diamond') && !t.classList.contains('revealed-mine')) {
                t.classList.add('fade');
                t.innerHTML = Math.random() > 0.8 ? "ðŸ’£" : "ðŸ’Ž";
            }
        });
    }

    function getMulti(count) {
        if (currentMode === 'easy') return easyMults[count] || 1000;
        if (currentMode === 'medium') return medMults[count - 1] || 1100;
        return hardMults[0];
    }

    function updateMultiUI() {
        document.getElementById('currMulti').innerText = (revealedCount === 0 ? "1.00" : getMulti(revealedCount)) + "x";
        document.getElementById('nextMulti').innerText = getMulti(revealedCount + 1) + "x";
    }

    window.closeModals = () => {
        document.getElementById('winModal').style.display = 'none';
        createGrid();
    };

    checkAutoLogin();
</script>
</body>
</html>
